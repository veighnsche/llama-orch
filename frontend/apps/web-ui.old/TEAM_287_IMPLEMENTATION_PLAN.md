# TEAM-287: Live Heartbeat Monitor Implementation Plan

**Date:** Oct 24, 2025  
**Status:** üìã **READY TO IMPLEMENT**  
**Target:** `frontend/apps/web-ui` (Next.js 15.5.5 + React 19)  
**SDK:** `consumers/rbee-sdk` (Rust + WASM)

---

## Mission

Implement live heartbeat monitoring in the web-ui using the rbee-sdk WASM package. This will display real-time worker and hive status updates every 5 seconds.

---

## Prerequisites Checklist

### ‚úÖ Already Complete
- [x] SDK dependency configured in package.json (`@rbee/sdk`: `../../consumers/rbee-sdk`)
- [x] pnpm workspace configured
- [x] shadcn/ui components available (`@rbee/ui`)
- [x] Next.js 15.5.5 + React 19 setup
- [x] Stub page.tsx with placeholder cards

### ‚è≥ Needs Implementation
- [ ] WASM webpack configuration in next.config.ts
- [ ] Build WASM package
- [ ] React hooks for SDK integration
- [ ] Update page.tsx to use live heartbeat data
- [ ] Update package.json to use `workspace:*` for SDK

---

## Implementation Steps

### Step 1: Fix package.json Dependency (2 minutes)

**File:** `frontend/apps/web-ui/package.json`

**Change line 31 from:**
```json
"@rbee/sdk": "../../consumers/rbee-sdk",
```

**To:**
```json
"@rbee/sdk": "workspace:*",
```

**Why:** Follow monorepo best practices using workspace protocol.

---

### Step 2: Build WASM Package (5 minutes)

**Commands:**
```bash
cd /home/vince/Projects/llama-orch/consumers/rbee-sdk
wasm-pack build --target bundler --out-dir pkg/bundler
```

**Expected output:**
- `pkg/bundler/rbee_sdk_bg.wasm` (593 KB)
- `pkg/bundler/rbee_sdk.js`
- `pkg/bundler/rbee_sdk.d.ts` (TypeScript types)
- `pkg/bundler/package.json`

**Verification:**
```bash
ls -lh pkg/bundler/rbee_sdk_bg.wasm
# Should show ~593 KB file
```

---

### Step 3: Update next.config.ts (3 minutes)

**File:** `frontend/apps/web-ui/next.config.ts`

**Replace entire file with:**
```typescript
// TEAM-287: Enable WASM support for rbee-sdk
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  reactStrictMode: true,
  transpilePackages: ['@rbee/ui'],
  
  // TEAM-287: Enable WASM support
  webpack: (config, { isServer }) => {
    // Add WASM support
    config.experiments = {
      ...config.experiments,
      asyncWebAssembly: true,
    };
    
    // Handle .wasm files
    config.module.rules.push({
      test: /\.wasm$/,
      type: 'webassembly/async',
    });
    
    return config;
  },
};

export default nextConfig;
```

**Why:** Next.js needs explicit webpack configuration to handle WASM modules.

---

### Step 4: Create hooks/ Directory (1 minute)

**Commands:**
```bash
mkdir -p /home/vince/Projects/llama-orch/frontend/apps/web-ui/src/hooks
```

---

### Step 5: Create useRbeeSDK Hook (10 minutes)

**File:** `frontend/apps/web-ui/src/hooks/useRbeeSDK.ts`

**Purpose:** Load WASM module and initialize SDK

**Implementation:**
```typescript
// TEAM-287: React hook for rbee-sdk WASM initialization

'use client';

import { useState, useEffect } from 'react';

// Type definitions (auto-generated by wasm-pack)
type RbeeClient = any;
type HeartbeatMonitor = any;
type OperationBuilder = any;

interface RbeeSDK {
  RbeeClient: typeof RbeeClient;
  HeartbeatMonitor: typeof HeartbeatMonitor;
  OperationBuilder: typeof OperationBuilder;
}

export function useRbeeSDK() {
  const [sdk, setSDK] = useState<RbeeSDK | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);

  useEffect(() => {
    async function loadWASM() {
      try {
        // TEAM-287: Dynamic import of WASM module
        // This works in Next.js 15 with webpack asyncWebAssembly
        const wasmModule = await import('@rbee/sdk');
        
        // Initialize WASM (calls init() automatically in bundler mode)
        await wasmModule.default();
        
        setSDK({
          RbeeClient: wasmModule.RbeeClient,
          HeartbeatMonitor: wasmModule.HeartbeatMonitor,
          OperationBuilder: wasmModule.OperationBuilder,
        });
        setLoading(false);
      } catch (err) {
        console.error('Failed to load rbee-sdk WASM:', err);
        setError(err as Error);
        setLoading(false);
      }
    }

    loadWASM();
  }, []);

  return { sdk, loading, error };
}
```

**Key features:**
- Dynamic WASM import (client-side only)
- Automatic initialization
- Error handling
- Loading state

---

### Step 6: Create useHeartbeat Hook (15 minutes)

**File:** `frontend/apps/web-ui/src/hooks/useHeartbeat.ts`

**Purpose:** Connect to SSE heartbeat stream and provide live updates

**Implementation:**
```typescript
// TEAM-287: React hook for heartbeat monitoring

'use client';

import { useState, useEffect, useRef } from 'react';
import { useRbeeSDK } from './useRbeeSDK';

interface HeartbeatSnapshot {
  timestamp: string;
  workers_online: number;
  workers_available: number;
  hives_online: number;
  hives_available: number;
  worker_ids: string[];
  hive_ids: string[];
}

export function useHeartbeat(baseUrl: string = 'http://localhost:8500') {
  const { sdk, loading: sdkLoading } = useRbeeSDK();
  const [heartbeat, setHeartbeat] = useState<HeartbeatSnapshot | null>(null);
  const [connected, setConnected] = useState(false);
  const [error, setError] = useState<Error | null>(null);
  const monitorRef = useRef<any>(null);

  useEffect(() => {
    if (!sdk) return;

    // Create monitor
    const monitor = new sdk.HeartbeatMonitor(baseUrl);
    monitorRef.current = monitor;

    try {
      // Start monitoring
      monitor.start((snapshot: HeartbeatSnapshot) => {
        setHeartbeat(snapshot);
        setConnected(true);
        setError(null);
      });

      // Check connection after a moment
      setTimeout(() => {
        if (monitor.isConnected()) {
          setConnected(true);
        }
      }, 1000);
    } catch (err) {
      setError(err as Error);
      setConnected(false);
    }

    // Cleanup
    return () => {
      if (monitorRef.current) {
        monitorRef.current.stop();
      }
    };
  }, [sdk, baseUrl]);

  return {
    heartbeat,
    connected,
    loading: sdkLoading,
    error,
  };
}
```

**Key features:**
- Automatic connection to SSE stream
- Real-time updates (5-second intervals)
- Connection status tracking
- Automatic cleanup on unmount
- Error handling

---

### Step 7: Update page.tsx (20 minutes)

**File:** `frontend/apps/web-ui/src/app/page.tsx`

**Replace entire file with:**
```typescript
// TEAM-287: Live heartbeat monitoring dashboard

'use client';

import { useHeartbeat } from '@/hooks/useHeartbeat';
import { Button } from '@rbee/ui/components/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@rbee/ui/components/card';

export default function HomePage() {
  const { heartbeat, connected, loading, error } = useHeartbeat();

  // Loading state
  if (loading) {
    return (
      <div className="min-h-screen bg-background p-8">
        <div className="text-center">
          <h1 className="text-4xl font-bold mb-4">üêù rbee Web UI</h1>
          <p className="text-muted-foreground">Loading rbee SDK...</p>
        </div>
      </div>
    );
  }

  // Error state
  if (error) {
    return (
      <div className="min-h-screen bg-background p-8">
        <div className="text-center">
          <h1 className="text-4xl font-bold mb-4 text-red-500">‚ö†Ô∏è Error</h1>
          <p className="text-muted-foreground mb-4">Failed to load rbee SDK</p>
          <p className="text-sm text-red-500">{error.message}</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-background p-8">
      <header className="mb-8">
        <h1 className="text-4xl font-bold mb-2">üêù rbee Web UI</h1>
        <p className="text-muted-foreground">
          Dashboard for managing queen, hives, workers, and models
        </p>
      </header>

      <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {/* Queen Status Card */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center justify-between">
              Queen Status
              <span className={connected ? 'text-green-500' : 'text-red-500'}>
                {connected ? 'üü¢' : '‚ö´'}
              </span>
            </CardTitle>
            <CardDescription>Central orchestrator</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="flex items-center gap-2">
              <div
                className={`h-3 w-3 rounded-full ${
                  connected ? 'bg-green-500' : 'bg-red-500'
                }`}
              />
              <span className="capitalize">
                {connected ? 'Connected' : 'Disconnected'}
              </span>
            </div>
            {heartbeat && (
              <p className="text-xs text-muted-foreground mt-2">
                Last update: {new Date(heartbeat.timestamp).toLocaleTimeString()}
              </p>
            )}
          </CardContent>
        </Card>

        {/* Hives Card */}
        <Card>
          <CardHeader>
            <CardTitle>Hives</CardTitle>
            <CardDescription>Pool managers</CardDescription>
          </CardHeader>
          <CardContent>
            <p className="text-2xl font-bold">
              {heartbeat?.hives_online ?? 0}
            </p>
            <p className="text-sm text-muted-foreground">
              {heartbeat?.hives_available ?? 0} available
            </p>
            {heartbeat?.hive_ids && heartbeat.hive_ids.length > 0 && (
              <ul className="mt-2 space-y-1">
                {heartbeat.hive_ids.map((id) => (
                  <li key={id} className="text-xs text-muted-foreground">
                    {id}
                  </li>
                ))}
              </ul>
            )}
            <Button className="mt-4" variant="outline" size="sm">
              Add Hive
            </Button>
          </CardContent>
        </Card>

        {/* Workers Card */}
        <Card>
          <CardHeader>
            <CardTitle>Workers</CardTitle>
            <CardDescription>Active executors</CardDescription>
          </CardHeader>
          <CardContent>
            <p className="text-2xl font-bold">
              {heartbeat?.workers_online ?? 0}
            </p>
            <p className="text-sm text-muted-foreground">
              {heartbeat?.workers_available ?? 0} available
            </p>
            {heartbeat?.worker_ids && heartbeat.worker_ids.length > 0 && (
              <ul className="mt-2 space-y-1">
                {heartbeat.worker_ids.slice(0, 5).map((id) => (
                  <li key={id} className="text-xs text-muted-foreground">
                    {id}
                  </li>
                ))}
                {heartbeat.worker_ids.length > 5 && (
                  <li className="text-xs text-muted-foreground">
                    +{heartbeat.worker_ids.length - 5} more
                  </li>
                )}
              </ul>
            )}
            <Button className="mt-4" variant="outline" size="sm">
              Spawn Worker
            </Button>
          </CardContent>
        </Card>

        {/* Models Card */}
        <Card>
          <CardHeader>
            <CardTitle>Models</CardTitle>
            <CardDescription>Downloaded models</CardDescription>
          </CardHeader>
          <CardContent>
            <p className="text-2xl font-bold">0</p>
            <p className="text-sm text-muted-foreground">No models available</p>
            <Button className="mt-4" variant="outline" size="sm">
              Download Model
            </Button>
          </CardContent>
        </Card>

        {/* Inference Card */}
        <Card className="md:col-span-2">
          <CardHeader>
            <CardTitle>Quick Inference</CardTitle>
            <CardDescription>Test model with a prompt</CardDescription>
          </CardHeader>
          <CardContent>
            <p className="text-sm text-muted-foreground mb-4">
              {connected
                ? 'Ready for inference (feature coming soon)'
                : 'Connect to queen to start inference'}
            </p>
            <Button variant="default" disabled={!connected}>
              Run Inference
            </Button>
          </CardContent>
        </Card>
      </div>

      <footer className="mt-8 text-center text-sm text-muted-foreground">
        <p>rbee Web UI v0.1.0 - TEAM-287</p>
        <p className="mt-1">
          Status: Live heartbeat monitoring active
          {heartbeat && ` ‚Ä¢ Updates every 5 seconds`}
        </p>
      </footer>
    </div>
  );
}
```

**Key features:**
- Live worker/hive counts
- Connection status indicator
- Last update timestamp
- Worker/hive ID lists
- Loading and error states
- Responsive grid layout

---

### Step 8: Install Dependencies (2 minutes)

**Commands:**
```bash
cd /home/vince/Projects/llama-orch/frontend/apps/web-ui
pnpm install
```

**This will:**
- Link `@rbee/sdk` from workspace
- Install all dependencies
- Set up symlinks

---

### Step 9: Test the Integration (5 minutes)

**Terminal 1 - Start queen-rbee:**
```bash
cd /home/vince/Projects/llama-orch
cargo run --bin queen-rbee
```

**Terminal 2 - Start web-ui:**
```bash
cd /home/vince/Projects/llama-orch/frontend/apps/web-ui
pnpm dev
```

**Browser:**
- Open http://localhost:3002
- Should see "Loading rbee SDK..." briefly
- Then see live dashboard with green indicator
- Worker/hive counts should update every 5 seconds

---

## Verification Checklist

### ‚úÖ WASM Build
- [ ] `pkg/bundler/rbee_sdk_bg.wasm` exists (~593 KB)
- [ ] `pkg/bundler/rbee_sdk.d.ts` exists (TypeScript types)
- [ ] No build errors

### ‚úÖ Next.js Configuration
- [ ] `next.config.ts` has webpack WASM config
- [ ] No webpack errors on dev server start

### ‚úÖ React Hooks
- [ ] `src/hooks/useRbeeSDK.ts` created
- [ ] `src/hooks/useHeartbeat.ts` created
- [ ] No TypeScript errors

### ‚úÖ Page Integration
- [ ] `src/app/page.tsx` updated
- [ ] Shows loading state initially
- [ ] Shows live data after connection
- [ ] Green indicator when connected
- [ ] Worker/hive counts update every 5 seconds

### ‚úÖ Runtime Behavior
- [ ] No console errors
- [ ] SSE connection established
- [ ] Heartbeat updates every 5 seconds
- [ ] Connection indicator accurate
- [ ] Automatic reconnection on disconnect

---

## File Summary

### Files to Create (3 files)
1. `src/hooks/useRbeeSDK.ts` (60 lines)
2. `src/hooks/useHeartbeat.ts` (75 lines)
3. `TEAM_287_IMPLEMENTATION_PLAN.md` (this file)

### Files to Modify (3 files)
1. `package.json` (1 line change)
2. `next.config.ts` (add webpack config)
3. `src/app/page.tsx` (complete rewrite)

### Total Lines of Code
- **New code:** ~135 lines (hooks)
- **Modified code:** ~150 lines (page.tsx)
- **Config changes:** ~15 lines
- **Total:** ~300 lines

---

## Expected Results

### Before Implementation
- Static placeholder cards
- No live data
- "Disconnected" status
- All counts show 0

### After Implementation
- ‚úÖ Live heartbeat monitoring
- ‚úÖ Real-time worker/hive counts
- ‚úÖ Connection status indicator (green/red)
- ‚úÖ Worker/hive ID lists
- ‚úÖ Last update timestamp
- ‚úÖ Automatic updates every 5 seconds
- ‚úÖ Error handling and loading states

---

## Troubleshooting

### Issue: "Module not found: Can't resolve '@rbee/sdk'"

**Solution:**
```bash
cd consumers/rbee-sdk
wasm-pack build --target bundler
cd ../../frontend/apps/web-ui
pnpm install
```

### Issue: "WebAssembly module is included in initial chunk"

**Solution:** Already handled by `asyncWebAssembly: true` in next.config.ts

### Issue: "Cannot use import statement outside a module"

**Solution:** Ensure `'use client'` directive at top of all hook files

### Issue: Heartbeat not connecting

**Check:**
1. queen-rbee is running on port 8500
2. No CORS errors in browser console
3. URL is correct in useHeartbeat hook
4. SSE endpoint is accessible: http://localhost:8500/v1/heartbeats/stream

---

## Performance Notes

### WASM Bundle Size
- Uncompressed: ~593 KB
- Gzipped: ~150-180 KB
- Load time: ~100-200ms (first load)
- Cached: instant

### Runtime Performance
- Near-native performance
- No GC pauses
- Efficient memory usage
- SSE connection: minimal overhead

### Network Usage
- SSE connection: persistent (1 connection)
- Updates: ~200 bytes every 5 seconds
- Bandwidth: ~40 bytes/second

---

## Next Steps (After This Implementation)

### Phase 2: Full Operations Support
1. Implement `useRbeeClient` hook
2. Add operation submission UI
3. Add streaming inference component
4. Add model management UI
5. Add worker management UI

### Phase 3: Advanced Features
1. Add charts/graphs for metrics
2. Add historical data views
3. Add notifications/alerts
4. Add configuration UI
5. Add logs viewer

---

## Success Criteria

### Minimum Viable Implementation (This Plan)
- ‚úÖ WASM SDK loads successfully
- ‚úÖ Heartbeat monitor connects
- ‚úÖ Live worker/hive counts display
- ‚úÖ Connection status indicator works
- ‚úÖ Updates every 5 seconds
- ‚úÖ No console errors
- ‚úÖ Responsive UI

### Definition of Done
- [ ] All files created/modified
- [ ] WASM builds successfully
- [ ] Next.js dev server starts without errors
- [ ] Dashboard shows live data
- [ ] Connection indicator accurate
- [ ] Updates visible every 5 seconds
- [ ] No TypeScript errors
- [ ] No runtime errors
- [ ] Code follows TEAM-287 signature pattern

---

## Time Estimate

### Development Time
- Step 1 (package.json): 2 minutes
- Step 2 (WASM build): 5 minutes
- Step 3 (next.config.ts): 3 minutes
- Step 4 (create hooks dir): 1 minute
- Step 5 (useRbeeSDK hook): 10 minutes
- Step 6 (useHeartbeat hook): 15 minutes
- Step 7 (page.tsx): 20 minutes
- Step 8 (install deps): 2 minutes
- Step 9 (testing): 5 minutes

**Total: ~60 minutes (1 hour)**

### Testing Time
- Manual testing: 15 minutes
- Edge case testing: 10 minutes
- Documentation: 5 minutes

**Total: ~30 minutes**

### Grand Total: ~1.5 hours

---

## Engineering Rules Compliance

### ‚úÖ Code Signatures
- All new files will have `// TEAM-287:` comments
- All modifications will have `// TEAM-287:` markers

### ‚úÖ Documentation
- This implementation plan serves as documentation
- No multiple .md files for one task
- Single source of truth

### ‚úÖ No TODO Markers
- All code will be fully implemented
- No "TODO: implement X" comments
- Complete working solution

### ‚úÖ Workspace Dependencies
- Using `workspace:*` protocol
- Following monorepo best practices
- No relative path imports

---

**Prepared by:** TEAM-287  
**Date:** Oct 24, 2025  
**Estimated Effort:** 1.5 hours  
**Status:** Ready to implement

**TEAM-287 SIGNATURE:** All code in this implementation will be tagged with TEAM-287 comments for historical context.
