# proof-bundle — Production Readiness Checklist

Status: Draft
Owner: @llama-orch-maintainers
Scope: `libs/proof-bundle`

This checklist enumerates everything required for the `proof-bundle` crate to be considered production-ready under the home profile. It references the normative spec in `/.specs/00_proof-bundle.md` (PB-1xxx) and the crate contracts in `/.specs/10_contracts.md`.

---

## 0) Spec & Contracts Compliance

- [ ] PB-1001 Location & Naming: default path `<crate>/.proof_bundle/<type>/<run_id>/...` (or `$LLORCH_PROOF_DIR/...`) verified.
- [ ] PB-1002 Run ID resolution: honors `LLORCH_RUN_ID`; fallback format `YYYYMMDD-HHMMSS-<git_sha8>` or epoch seconds; never fails on missing git.
- [ ] PB-1003 Base directory override: `$LLORCH_PROOF_DIR` takes precedence.
- [ ] PB-1004 File formats & extensions: NDJSON (`.ndjson`/`.jsonl`) for streams, pretty `.json` for configs, Markdown for summaries.
- [ ] PB-1005 Minimal API surface present and documented.
- [ ] PB-1006 Safety & idempotency: parent dirs created; NDJSON appends newline-terminated; overwrites for JSON/Markdown.
- [ ] PB-1007 Redaction policy: crate does not redact; docs mandate callers MUST redact secrets.
- [ ] PB-1008 Error handling: returns `anyhow::Result`, no panics on normal IO.
- [ ] PB-1009 Concurrency note: documented lack of atomic multi-writer guarantees.
- [ ] PB-1010 Test type mapping exact (`Unit→unit`, `Integration→integration`, `Contract→contract`, `Bdd→bdd`, `Determinism→determinism`, `Smoke→home-profile-smoke`, `E2eHaiku→e2e-haiku`).
- [ ] PB-1011 Cross-platform assumptions (Linux target) are documented.
- [ ] PB-1012 Autogenerated headers: enforced automatically (Markdown header line, NDJSON first metadata record, JSON sibling `.meta`).
- [ ] PBV-2001..PBV-2009 tests exist and pass locally and in CI.

Commands:
- `cargo test -p proof-bundle -- --nocapture`
- `bash ci/scripts/check_proof_bundle_headers.sh` (optionally scoped to a path)

---

## 1) API Surface & Stability

- [ ] Public API is minimal, coherent, and documented with rustdoc on all items.
- [ ] `ProofBundle` and `TestType` semantics are clearly explained in `README.md` with examples.
- [ ] Helper APIs exist for headers/metadata: `write_markdown_with_header`, `append_ndjson_autogen_meta`, `write_meta_sibling`, `write_json_with_meta`.
- [ ] Error model chosen: `anyhow` acceptable for internal tool crates; re-evaluate if moving to external consumption.
- [ ] No panics; no `unwrap()` in public codepaths.
- [ ] Naming aligns with repo conventions (snake_case modules, UpperCamelCase public types).

---

## 2) Input Hardening & Path Safety

- [ ] Validate/sanitize artifact names where appropriate to avoid path traversal (no `..`, leading `/`, or path separators injected via `name`).
- [ ] Document that `name` parameters are treated as file names (not paths). Consider rejecting path components.
- [ ] Consider a `safe_name()` helper or enum for known artifact roles (future work).

Action items:
- [ ] Add `sanitize_name(name: &str) -> Result<String>` and apply in writers (PB-FW-01).

---

## 3) Concurrency & Atomicity

- [ ] Document that concurrent writers to the same file are not synchronized.
- [ ] Provide optional file-locking or `Mutex`/`parking_lot`-based helpers if required by consumers (future).
- [ ] Ensure newlines on every NDJSON write (no partial records).

Action items:
- [ ] Evaluate `fs2`-style file locking or per-file lock map for multi-threaded test harnesses (PB-FW-02).

---

## 4) Performance & Scale

- [ ] Reasonable performance for append-only NDJSON files (no O(n) rewrites).
- [ ] Consider buffered writer path for high-volume streams (future optimization).
- [ ] Optional: micro-benchmark with `criterion` for NDJSON append and JSON write.

Action items:
- [ ] Add a simple bench under `benches/` to detect regressions (PB-FW-03).

---

## 5) Testing Depth

- [ ] Unit tests hit all public functions (happy-path + failure-path).
- [ ] Conformance tests validate PBV-2xxx and helpers (already added).
- [ ] Tests for env var isolation (serial), overriding base, and run_id entropy.
- [ ] Tests for header enforcement on all formats.
- [ ] Tests for illegal names (once sanitize_name is added).

Commands:
- `cargo test -p proof-bundle -- --nocapture`

---

## 6) Documentation Quality

- [ ] `libs/proof-bundle/README.md` updated with header guidance and examples.
- [ ] `/.specs/00_proof-bundle.md` and `/.specs/10_contracts.md` reflect current behavior.
- [ ] Per-type docs and templates updated (done):
  - `/.proof_bundle/templates/*/README.md`
  - `/.docs/testing/TEST_TYPES_GUIDE.md`
  - `/.docs/testing/TESTING_POLICY.md`
  - `/.docs/testing/types/*.md`
- [ ] Add API rustdoc examples for each helper.

---

## 7) CI Integration & Gates

- [ ] Pipeline runs `cargo fmt`, `clippy -D warnings`, regen tasks, and tests (already present in `ci/pipelines.yml`).
- [ ] Header checker script added: `ci/scripts/check_proof_bundle_headers.sh`.
- [ ] Pipeline step to run header checker after tests (to be added or confirmed):
  - [ ] Add a job (or extend existing) to run: `bash ci/scripts/check_proof_bundle_headers.sh`.
- [ ] Optional: upload recent bundles as build artifacts for debugging.

Action items:
- [ ] Patch `ci/pipelines.yml` to include header checker in relevant jobs (PB-CI-01).

---

## 8) Security & Privacy

- [ ] Crate never logs or writes secrets; callers must redact.
- [ ] Explicit redaction guidance in central docs and templates.
- [ ] No external network I/O; filesystem only under specified dirs.
- [ ] Respect environment variables exactly; no shell execution.

---

## 9) Packaging & Licensing

- [ ] `Cargo.toml` contains `license = "GPL-3.0-or-later"`, authors, description.
- [ ] If publishing externally (not planned): add `repository`, `homepage`, `documentation`, `keywords`, `categories`.
- [ ] Internal-only policy noted in README (if applicable).

---

## 10) Operational Considerations

- [ ] Clear default: current working directory `.proof_bundle` (crate-local under Cargo test execution).
- [ ] Override for CI: `LLORCH_PROOF_DIR` to point bundles to a known workspace dir.
- [ ] Recommended `LLORCH_RUN_ID` format and setting in CI.
- [ ] Cleanup policy for stale runs (pre-1.0 okay to be destructive per repo rules).

---

## 11) Maintenance & Ownership

- [ ] Codeowners include crate owners (`CODEOWNERS`).
- [ ] `TODO.md` updated with any open items and archived after completion.
- [ ] Changelog entries for user-visible behavior (header enforcement was added).

---

## 12) Acceptance — Sign-off

- [ ] All PB-1xxx items verified; PBV-2xxx tests pass.
- [ ] CI header checker integrated and green.
- [ ] Input hardening (sanitize_name) implemented and covered by tests.
- [ ] Concurrency guidance documented; locking decision recorded.
- [ ] Bench (optional) added or consciously deferred with rationale.
- [ ] Docs updated and cross-linked; examples compile.

Sign-offs:
- [ ] Maintainer review
- [ ] Testing lead review
- [ ] Docs review

---

## Appendix — Quick Commands

```bash
# Format & lint
cargo fmt --all -- --check
cargo clippy --all-targets --all-features -- -D warnings

# Tests
cargo test -p proof-bundle -- --nocapture

# Header checks (scope to repo or a specific crate directory)
bash ci/scripts/check_proof_bundle_headers.sh
bash ci/scripts/check_proof_bundle_headers.sh libs/proof-bundle
```
