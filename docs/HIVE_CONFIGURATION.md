# Hive Configuration Guide

**Created by:** TEAM-198

## Overview

rbee uses file-based configuration for managing hive installations. All configuration lives in `~/.config/rbee/`.

## Configuration Files

### config.toml (Queen Settings)

Location: `~/.config/rbee/config.toml`

```toml
[queen]
port = 8080
log_level = "info"

[runtime]
max_concurrent_operations = 10
```

**Fields:**
- `queen.port` - Port for queen-rbee HTTP API (default: 8080)
- `queen.log_level` - Log level: "trace", "debug", "info", "warn", "error" (default: "info")
- `runtime.max_concurrent_operations` - Max parallel operations (default: 10)

### hives.conf (Hive Definitions)

Location: `~/.config/rbee/hives.conf`

Format: SSH config style

```ssh-config
# Localhost hive
Host localhost
    HostName 127.0.0.1
    Port 22
    User vince
    HivePort 8081
    BinaryPath /usr/local/bin/rbee-hive

# Remote workstation
Host workstation
    HostName 192.168.1.100
    Port 22
    User admin
    HivePort 8081

# Cloud GPU server
Host gpu-cloud
    HostName gpu.example.com
    Port 2222
    User ubuntu
    HivePort 8082
```

**Required Fields:**
- `Host` - Unique alias for the hive
- `HostName` - IP address or hostname
- `Port` - SSH port (default: 22)
- `User` - SSH username
- `HivePort` - Port for rbee-hive HTTP API

**Optional Fields:**
- `BinaryPath` - Path to rbee-hive binary (auto-detected if omitted)

**Important:**
- Each `Host` alias must be unique
- Comments start with `#`
- Indentation is required (4 spaces or 1 tab)

### capabilities.yaml (Auto-Generated)

Location: `~/.config/rbee/capabilities.yaml`

**DO NOT EDIT MANUALLY** - This file is auto-generated by queen-rbee.

Contains cached device information for running hives.

## Usage

### Install a Hive

```bash
# 1. Add hive to hives.conf
cat >> ~/.config/rbee/hives.conf << EOF
Host my-hive
    HostName 192.168.1.100
    Port 22
    User admin
    HivePort 8081
EOF

# 2. Install using alias
./rbee hive install -h my-hive
```

### Start a Hive

```bash
./rbee hive start -h my-hive
```

### Stop a Hive

```bash
./rbee hive stop -h my-hive
```

### List Hives

```bash
./rbee hive list
```

### Uninstall a Hive

```bash
# 1. Uninstall (stops the process)
./rbee hive uninstall -h my-hive

# 2. Remove from config (manual)
# Edit ~/.config/rbee/hives.conf and remove the Host entry
```

### Test SSH Connection

```bash
./rbee hive ssh-test -h my-hive
```

### Refresh Capabilities

```bash
./rbee hive refresh-capabilities -h my-hive
```

## Troubleshooting

### "Hive alias not found in hives.conf"

**Cause:** The alias doesn't exist in `~/.config/rbee/hives.conf`

**Solution:**
1. Check available hives: `./rbee hive list`
2. Add the hive to `hives.conf` (see Install a Hive)

### "Duplicate hive aliases detected"

**Cause:** Multiple `Host` entries have the same alias

**Solution:**
1. Edit `~/.config/rbee/hives.conf`
2. Ensure each `Host` line has a unique name

### "Failed to connect to hive"

**Possible causes:**
- Hive is not running
- Port is blocked by firewall
- Hive crashed during startup

**Solutions:**
1. Check if hive is running: `./rbee hive list`
2. Check hive logs
3. Verify port is open: `nc -zv localhost 8081`

### "Binary not found"

**Cause:** rbee-hive binary not found in expected locations

**Solution:**
1. Build the binary: `cargo build --bin rbee-hive`
2. Or specify path in `hives.conf`:
   ```
   Host my-hive
       ...
       BinaryPath /path/to/rbee-hive
   ```

## Examples

### Localhost Development Setup

```ssh-config
Host dev
    HostName 127.0.0.1
    Port 22
    User $USER
    HivePort 8081
```

### Multi-GPU Workstation

```ssh-config
Host workstation
    HostName 192.168.1.100
    Port 22
    User admin
    HivePort 8081
```

### Cloud GPU Provider

```ssh-config
Host vast-ai-1
    HostName 123.45.67.89
    Port 2222
    User root
    HivePort 8081
    BinaryPath /opt/rbee/rbee-hive
```

## Best Practices

1. **Use descriptive aliases** - `gpu-workstation` instead of `ws1`
2. **Document your hives** - Add comments in `hives.conf`
3. **Keep ports consistent** - Use the same HivePort across hives if possible
4. **Backup your config** - `~/.config/rbee/` should be in version control
5. **Don't edit capabilities.yaml** - It's auto-generated

## Migration from SQLite

If you previously used the SQLite-based catalog:

1. Your old hive registrations are in the database
2. Manually add them to `~/.config/rbee/hives.conf`
3. The database will be ignored after migration

See `docs/MIGRATION_GUIDE.md` for details.
