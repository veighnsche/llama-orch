# Orchestrator SPEC v3.2 — Model Catalog/Lifecycle & Advanced Scheduling

Status: draft · Date: 2025-09-15

## Problem

- Lack of formal model catalog and trust policy reduces provenance and supply-chain guarantees.
- No lifecycle states for models; cannot freeze SLOs or block new sessions on deprecation.
- Scheduling lacks WFQ and EDF; deadlines and fairness cannot be enforced; no preemption semantics.

## Change Summary

- Add Catalog & Trust (provenance, signatures/attestations, digest pinning, SBOM retention, trust policy, verification telemetry) [ORCH-3060..3068].
- Introduce Lifecycle States (Draft→Active→Canary→Deprecated→Retired) with control-plane transitions and effects [ORCH-3069..3074].
- Advanced Scheduling: WFQ with per-tenant weights/quotas [ORCH-3075..3078]; EDF with feasibility and ETA-aware eviction [ORCH-3079..3084]; Soft/Hard preemption [ORCH-3085..3090]; Placement integration [ORCH-3091..3092].
- Glue: new typed errors and telemetry fields [ORCH-3093..3094].

## Impacted Areas

- `.specs/00_llama-orch.md` (v3.2 addendum, traceability, checklist)
- `contracts/openapi/control.yaml` (catalog endpoints and schemas)
- `contracts/openapi/data.yaml` (typed errors; SSE metrics fields)
- `contracts/config-schema/` (catalog policy, admission fairness, tenants, preemption)
- `.specs/metrics/otel-prom.md` and `ci/metrics.lint.json` (new metrics)
- Tests under `contracts/config-schema/tests/` and harness updates

## New/Changed Requirements (ORCH IDs)

- ORCH-3060..3066 Catalog & Trust (provenance, signatures, digest pinning, sbom retention, trust policy)
- ORCH-3067..3068 Tests for strict policy rejection and deterministic tag→digest resolution
- ORCH-3069..3074 Lifecycle states and effects; control-plane transition; telemetry
- ORCH-3075..3078 WFQ fairness across priorities/tenants; quotas
- ORCH-3079..3084 Deadline-aware admission (EDF), feasibility reject, metrics, SSE fields
- ORCH-3085..3090 Preemption (soft/hard capability), metrics, resumable state
- ORCH-3091..3092 Placement integration with WFQ/EDF/topology
- ORCH-3093 Typed errors {DEADLINE_UNMET, MODEL_DEPRECATED, UNTRUSTED_ARTIFACT}
- ORCH-3094 Telemetry fields {tenant_id, priority, weight, deadline_ms, on_time_probability, preempted}

## Acceptance Criteria

- SPEC updated with v3.2 addendum; Traceability Map and Compliance Checklist extended.
- OpenAPI updated with new endpoints and fields; `cargo xtask regen-openapi` is diff-clean and examples compile.
- Config schema extended; `cargo xtask regen-schema` is diff-clean.
- Metrics spec and linter updated; `bash ci/scripts/spec_lint.sh` and `bash ci/scripts/check_links.sh` pass; metrics contracts tests green.
- New tests:
  - Unsigned artifact rejected under strict trust policy.
  - Tag→digest deterministic resolution.
  - Deprecated blocks new sessions; pool drains; Retired unloads.
  - WFQ share approximates configured weights; EDF lowers missed deadlines; feasibility rejects return DEADLINE_UNMET.
  - Preemption semantics exercised; hard preemption gated on capability proof.

## References

- `.specs/00_llama-orch.md`
- `.specs/metrics/otel-prom.md`
- `contracts/openapi/data.yaml`
- `contracts/openapi/control.yaml`
- `contracts/config-schema/`
