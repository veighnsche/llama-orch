# Phase 6: Documentation

**Team:** TEAM-193  
**Duration:** 2-3 hours  
**Dependencies:** Phase 5 (TEAM-192) complete  
**Deliverables:** Complete user documentation, migration guide, updated READMEs

---

## Mission

Create comprehensive documentation for the new file-based configuration system. Users should be able to understand and use the new system without reading code.

---

## Documentation Tasks

### 6.1 User Guide

**Create:** `docs/HIVE_CONFIGURATION.md`

**Contents:**

```markdown
# Hive Configuration Guide

## Overview

rbee uses file-based configuration for managing hive installations. All configuration lives in `~/.config/rbee/`.

## Configuration Files

### config.toml (Queen Settings)

Location: `~/.config/rbee/config.toml`

```toml
[queen]
port = 8080
log_level = "info"

[runtime]
max_concurrent_operations = 10
```

**Fields:**
- `queen.port` - Port for queen-rbee HTTP API (default: 8080)
- `queen.log_level` - Log level: "trace", "debug", "info", "warn", "error" (default: "info")
- `runtime.max_concurrent_operations` - Max parallel operations (default: 10)

### hives.conf (Hive Definitions)

Location: `~/.config/rbee/hives.conf`

Format: SSH config style

```ssh-config
# Localhost hive
Host localhost
    HostName 127.0.0.1
    Port 22
    User vince
    HivePort 8081
    BinaryPath /usr/local/bin/rbee-hive

# Remote workstation
Host workstation
    HostName 192.168.1.100
    Port 22
    User admin
    HivePort 8081

# Cloud GPU server
Host gpu-cloud
    HostName gpu.example.com
    Port 2222
    User ubuntu
    HivePort 8082
```

**Required Fields:**
- `Host` - Unique alias for the hive
- `HostName` - IP address or hostname
- `Port` - SSH port (default: 22)
- `User` - SSH username
- `HivePort` - Port for rbee-hive HTTP API

**Optional Fields:**
- `BinaryPath` - Path to rbee-hive binary (auto-detected if omitted)

**Important:**
- Each `Host` alias must be unique
- Comments start with `#`
- Indentation is required (4 spaces or 1 tab)

### capabilities.yaml (Auto-Generated)

Location: `~/.config/rbee/capabilities.yaml`

**DO NOT EDIT MANUALLY** - This file is auto-generated by queen-rbee.

Contains cached device information for running hives.

## Usage

### Install a Hive

```bash
# 1. Add hive to hives.conf
cat >> ~/.config/rbee/hives.conf << EOF
Host my-hive
    HostName 192.168.1.100
    Port 22
    User admin
    HivePort 8081
EOF

# 2. Install using alias
./rbee hive install -h my-hive
```

### Start a Hive

```bash
./rbee hive start -h my-hive
```

### Stop a Hive

```bash
./rbee hive stop -h my-hive
```

### List Hives

```bash
./rbee hive list
```

### Uninstall a Hive

```bash
# 1. Uninstall (stops the process)
./rbee hive uninstall -h my-hive

# 2. Remove from config (manual)
# Edit ~/.config/rbee/hives.conf and remove the Host entry
```

### Test SSH Connection

```bash
./rbee hive ssh-test -h my-hive
```

### Refresh Capabilities

```bash
./rbee hive refresh-capabilities -h my-hive
```

## Troubleshooting

### "Hive alias not found in hives.conf"

**Cause:** The alias doesn't exist in `~/.config/rbee/hives.conf`

**Solution:**
1. Check available hives: `./rbee hive list`
2. Add the hive to `hives.conf` (see Install a Hive)

### "Duplicate hive aliases detected"

**Cause:** Multiple `Host` entries have the same alias

**Solution:**
1. Edit `~/.config/rbee/hives.conf`
2. Ensure each `Host` line has a unique name

### "Failed to connect to hive"

**Possible causes:**
- Hive is not running
- Port is blocked by firewall
- Hive crashed during startup

**Solutions:**
1. Check if hive is running: `./rbee hive list`
2. Check hive logs
3. Verify port is open: `nc -zv localhost 8081`

### "Binary not found"

**Cause:** rbee-hive binary not found in expected locations

**Solution:**
1. Build the binary: `cargo build --bin rbee-hive`
2. Or specify path in `hives.conf`:
   ```
   Host my-hive
       ...
       BinaryPath /path/to/rbee-hive
   ```

## Examples

### Localhost Development Setup

```ssh-config
Host dev
    HostName 127.0.0.1
    Port 22
    User $USER
    HivePort 8081
```

### Multi-GPU Workstation

```ssh-config
Host workstation
    HostName 192.168.1.100
    Port 22
    User admin
    HivePort 8081
```

### Cloud GPU Provider

```ssh-config
Host vast-ai-1
    HostName 123.45.67.89
    Port 2222
    User root
    HivePort 8081
    BinaryPath /opt/rbee/rbee-hive
```

## Best Practices

1. **Use descriptive aliases** - `gpu-workstation` instead of `ws1`
2. **Document your hives** - Add comments in `hives.conf`
3. **Keep ports consistent** - Use the same HivePort across hives if possible
4. **Backup your config** - `~/.config/rbee/` should be in version control
5. **Don't edit capabilities.yaml** - It's auto-generated

## Migration from SQLite

If you previously used the SQLite-based catalog:

1. Your old hive registrations are in the database
2. Manually add them to `~/.config/rbee/hives.conf`
3. The database will be ignored after migration

See `docs/MIGRATION_GUIDE.md` for details.
```

### 6.2 Migration Guide

**Create:** `docs/MIGRATION_GUIDE.md`

**Contents:**

```markdown
# Migration Guide: SQLite to File-Based Config

## Overview

rbee has migrated from SQLite-based hive catalog to file-based configuration.

## What Changed

### Before (SQLite)
- Hives stored in SQLite database
- CLI commands wrote to database
- `--id`, `--ssh-host`, `--ssh-user` flags required

### After (File-Based)
- Hives defined in `~/.config/rbee/hives.conf`
- User manually edits config file
- `-h <alias>` flag references config

## Migration Steps

### Step 1: Export Existing Hives

If you have existing hives in the SQLite database:

```bash
# List current hives
./rbee hive list

# Note down the details for each hive
```

### Step 2: Create hives.conf

Create `~/.config/rbee/hives.conf` and add your hives:

```ssh-config
Host <alias>
    HostName <ip-or-hostname>
    Port <ssh-port>
    User <ssh-user>
    HivePort <hive-port>
```

Example:

```ssh-config
Host localhost
    HostName 127.0.0.1
    Port 22
    User vince
    HivePort 8081

Host workstation
    HostName 192.168.1.100
    Port 22
    User admin
    HivePort 8081
```

### Step 3: Update CLI Commands

**Old commands:**
```bash
./rbee hive install --id my-hive --ssh-host 192.168.1.100 --ssh-user admin --port 8081
./rbee hive start --id my-hive
./rbee hive stop --id my-hive
```

**New commands:**
```bash
# First add to hives.conf, then:
./rbee hive install -h my-hive
./rbee hive start -h my-hive
./rbee hive stop -h my-hive
```

### Step 4: Verify Migration

```bash
# List hives (should read from hives.conf)
./rbee hive list

# Test a hive
./rbee hive ssh-test -h <alias>
```

## Breaking Changes

### CLI Arguments

| Old | New |
|-----|-----|
| `--id <id>` | `-h <alias>` or `--host <alias>` |
| `--ssh-host <host>` | Defined in `hives.conf` |
| `--ssh-port <port>` | Defined in `hives.conf` |
| `--ssh-user <user>` | Defined in `hives.conf` |
| `--port <port>` | `HivePort` in `hives.conf` |
| `--binary-path <path>` | `BinaryPath` in `hives.conf` |

### Programmatic Access

If you have scripts that use the CLI:

**Before:**
```bash
./rbee hive install --id hive1 --ssh-host 192.168.1.100 --ssh-user admin --port 8081
```

**After:**
```bash
# Add to hives.conf first (one-time setup)
cat >> ~/.config/rbee/hives.conf << EOF
Host hive1
    HostName 192.168.1.100
    Port 22
    User admin
    HivePort 8081
EOF

# Then use alias
./rbee hive install -h hive1
```

## FAQ

### Q: Can I still use the old CLI commands?

**A:** No, the old SQLite-based commands are removed. You must use the new file-based config.

### Q: Where is the SQLite database?

**A:** It's no longer used. The `hive-catalog` crate has been removed.

### Q: Can I automate hive registration?

**A:** Yes, by programmatically editing `~/.config/rbee/hives.conf`. It's a simple text file.

### Q: What happens to my old database?

**A:** It's ignored. You can safely delete it after migration.

### Q: Do I need to reinstall hives?

**A:** No, just add them to `hives.conf`. If they're already running, refresh capabilities:

```bash
./rbee hive refresh-capabilities -h <alias>
```

## Rollback

If you need to rollback (not recommended):

1. Checkout the previous version: `git checkout <old-commit>`
2. Rebuild: `cargo build --workspace`
3. Your old SQLite database should still work

## Support

If you encounter issues during migration:

1. Check `docs/HIVE_CONFIGURATION.md` for usage guide
2. Verify `hives.conf` syntax
3. Run with debug logging: `RUST_LOG=debug ./rbee hive list`
4. Open an issue on GitHub
```

### 6.3 Update README Files

#### Update `bin/15_queen_rbee_crates/rbee-config/README.md`

```markdown
# rbee-config

Configuration management for rbee.

## Overview

This crate provides file-based configuration for rbee, replacing the previous SQLite-based catalog.

## Configuration Files

- `~/.config/rbee/config.toml` - Queen-level settings
- `~/.config/rbee/hives.conf` - Hive definitions (SSH config style)
- `~/.config/rbee/capabilities.yaml` - Auto-generated device capabilities

## Usage

```rust
use rbee_config::RbeeConfig;

// Load all config files
let config = RbeeConfig::load()?;

// Validate config
config.validate()?;

// Get a hive by alias
if let Some(hive) = config.hives.get("localhost") {
    println!("Hive: {}@{}:{}", hive.ssh_user, hive.hostname, hive.hive_port);
}

// Update capabilities
let caps = HiveCapabilities {
    alias: "localhost".to_string(),
    devices: vec![/* ... */],
    last_updated_ms: chrono::Utc::now().timestamp_millis(),
    endpoint: "http://localhost:8081".to_string(),
};

config.capabilities.update_hive("localhost".to_string(), caps);
config.capabilities.save()?;
```

## Features

- SSH config style parsing
- Automatic config directory creation
- Alias uniqueness validation
- Required field validation
- Auto-generated capabilities cache
- Thread-safe config access

## Testing

```bash
cargo test -p rbee-config
```

## Documentation

See `docs/HIVE_CONFIGURATION.md` for user guide.
```

#### Update Root `README.md`

Add section about configuration:

```markdown
## Configuration

rbee uses file-based configuration stored in `~/.config/rbee/`:

- `config.toml` - Queen-level settings
- `hives.conf` - Hive definitions (SSH config style)
- `capabilities.yaml` - Auto-generated device capabilities

See [docs/HIVE_CONFIGURATION.md](docs/HIVE_CONFIGURATION.md) for details.
```

### 6.4 Update CONTRIBUTING.md

Add section about config files:

```markdown
## Configuration Files

When developing rbee, you'll work with these config files:

- `~/.config/rbee/config.toml` - Queen settings
- `~/.config/rbee/hives.conf` - Hive definitions
- `~/.config/rbee/capabilities.yaml` - Auto-generated (don't edit)

For testing, you can use a different config directory:

```bash
export RBEE_CONFIG_DIR=/tmp/rbee-test-config
```

(Note: This requires implementing `RBEE_CONFIG_DIR` env var support)
```

### 6.5 Create Quick Reference Card

**Create:** `docs/HIVE_QUICK_REFERENCE.md`

```markdown
# Hive Quick Reference

## Config Files

```
~/.config/rbee/
├── config.toml          # Queen settings
├── hives.conf           # Hive definitions (edit this)
└── capabilities.yaml    # Auto-generated (don't edit)
```

## hives.conf Format

```ssh-config
Host <alias>
    HostName <ip-or-hostname>
    Port <ssh-port>
    User <ssh-user>
    HivePort <hive-port>
    BinaryPath <path>  # Optional
```

## Commands

| Command | Description |
|---------|-------------|
| `./rbee hive install -h <alias>` | Install hive |
| `./rbee hive start -h <alias>` | Start hive |
| `./rbee hive stop -h <alias>` | Stop hive |
| `./rbee hive uninstall -h <alias>` | Uninstall hive |
| `./rbee hive list` | List all hives |
| `./rbee hive ssh-test -h <alias>` | Test SSH connection |
| `./rbee hive refresh-capabilities -h <alias>` | Refresh device info |

## Workflow

1. **Add hive to config:**
   ```bash
   cat >> ~/.config/rbee/hives.conf << EOF
   Host my-hive
       HostName 192.168.1.100
       Port 22
       User admin
       HivePort 8081
   EOF
   ```

2. **Install:**
   ```bash
   ./rbee hive install -h my-hive
   ```

3. **Use:**
   ```bash
   ./rbee hive start -h my-hive
   ```

4. **Remove:**
   ```bash
   ./rbee hive uninstall -h my-hive
   # Then edit hives.conf to remove the Host entry
   ```

## Troubleshooting

| Error | Solution |
|-------|----------|
| "Alias not found" | Add to `hives.conf` |
| "Duplicate aliases" | Make aliases unique |
| "Binary not found" | Build with `cargo build --bin rbee-hive` |
| "Connection failed" | Check if hive is running |
```

---

## Acceptance Criteria

- [ ] `docs/HIVE_CONFIGURATION.md` created (complete user guide)
- [ ] `docs/MIGRATION_GUIDE.md` created (SQLite → file-based)
- [ ] `docs/HIVE_QUICK_REFERENCE.md` created (cheat sheet)
- [ ] `bin/15_queen_rbee_crates/rbee-config/README.md` updated
- [ ] Root `README.md` updated with config section
- [ ] `CONTRIBUTING.md` updated with config info
- [ ] All examples are tested and work
- [ ] Documentation is clear and comprehensive

---

## Verification

```bash
# Verify all docs exist
ls -la docs/HIVE_CONFIGURATION.md
ls -la docs/MIGRATION_GUIDE.md
ls -la docs/HIVE_QUICK_REFERENCE.md

# Check for broken links (if link checker exists)
./ci/scripts/check_links.sh

# Verify examples work
# (manually test each example in the docs)
```

---

## Handoff to TEAM-194

**What's ready:**
- ✅ Complete user documentation
- ✅ Migration guide for existing users
- ✅ Quick reference card
- ✅ Updated README files
- ✅ All examples tested

**Next steps:**
- Self-destruct: Delete `hive-catalog` crate
- Remove SQLite dependencies
- Clean up workspace

---

**Created by:** TEAM-187  
**For:** TEAM-193  
**Status:** 📋 Ready to implement
