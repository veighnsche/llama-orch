# Phase 1: Config File Design & Parser

**Team:** TEAM-188  
**Duration:** 4-6 hours  
**Dependencies:** None  
**Deliverables:** New `rbee-config` crate with SSH config parser

---

## Mission

Create a new configuration system that replaces SQLite with file-based config following SSH config conventions.

---

## Tasks

### 1.1 Create New Crate Structure

**Location:** `bin/15_queen_rbee_crates/rbee-config/`

**Files to create:**
```
rbee-config/
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ README.md
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib.rs              # Main entry point
â”‚   â”œâ”€â”€ queen_config.rs     # config.toml parser
â”‚   â”œâ”€â”€ hives_config.rs     # hives.conf parser (SSH style)
â”‚   â”œâ”€â”€ capabilities.rs     # capabilities.yaml reader/writer
â”‚   â”œâ”€â”€ validation.rs       # Uniqueness checks, preflight
â”‚   â””â”€â”€ error.rs            # Error types
â””â”€â”€ tests/
    â”œâ”€â”€ fixtures/
    â”‚   â”œâ”€â”€ valid_hives.conf
    â”‚   â”œâ”€â”€ invalid_hives.conf
    â”‚   â””â”€â”€ sample_capabilities.yaml
    â””â”€â”€ integration_tests.rs
```

### 1.2 Define Config File Formats

#### `config.toml` (Queen-level settings)
```toml
[queen]
port = 8080
log_level = "info"

[runtime]
max_concurrent_operations = 10
```

#### `hives.conf` (SSH config style)
```ssh-config
# Localhost hive
Host localhost
    HostName 127.0.0.1
    Port 22
    User vince
    HivePort 8081
    BinaryPath /usr/local/bin/rbee-hive

# Remote workstation
Host workstation
    HostName 192.168.1.100
    Port 22
    User admin
    HivePort 8081

# Cloud GPU server
Host gpu-cloud
    HostName gpu.example.com
    Port 2222
    User ubuntu
    HivePort 8082
```

#### `capabilities.yaml` (Auto-generated)
```yaml
# Auto-generated by queen-rbee
# DO NOT EDIT MANUALLY
last_updated: 2025-10-21T20:40:00Z

hives:
  localhost:
    alias: localhost
    devices:
      - id: "GPU-0"
        name: "NVIDIA RTX 4090"
        vram_gb: 24
        compute_capability: "8.9"
    last_updated_ms: 1729540800000

  workstation:
    alias: workstation
    devices:
      - id: "GPU-0"
        name: "NVIDIA A100"
        vram_gb: 80
        compute_capability: "8.0"
    last_updated_ms: 1729540800000
```

### 1.3 Implement Core API

**In `src/lib.rs`:**
```rust
pub struct RbeeConfig {
    pub queen: QueenConfig,
    pub hives: HivesConfig,
    pub capabilities: CapabilitiesCache,
}

impl RbeeConfig {
    /// Load all config files from ~/.config/rbee/
    pub fn load() -> Result<Self, ConfigError>;
    
    /// Get config directory path
    pub fn config_dir() -> PathBuf;
    
    /// Validate all config files
    pub fn validate(&self) -> Result<(), ConfigError>;
}
```

**In `src/hives_config.rs`:**
```rust
pub struct HivesConfig {
    hives: HashMap<String, HiveEntry>,
}

impl HivesConfig {
    /// Load from ~/.config/rbee/hives.conf
    pub fn load() -> Result<Self, ConfigError>;
    
    /// Get hive by alias
    pub fn get(&self, alias: &str) -> Option<&HiveEntry>;
    
    /// List all hives
    pub fn all(&self) -> Vec<&HiveEntry>;
    
    /// Validate unique aliases
    pub fn validate_unique_aliases(&self) -> Result<(), ConfigError>;
}

pub struct HiveEntry {
    pub alias: String,
    pub hostname: String,
    pub ssh_port: u16,
    pub ssh_user: String,
    pub hive_port: u16,
    pub binary_path: Option<String>,
}
```

**In `src/capabilities.rs`:**
```rust
pub struct CapabilitiesCache {
    path: PathBuf,
    data: HashMap<String, HiveCapabilities>,
}

impl CapabilitiesCache {
    /// Load from ~/.config/rbee/capabilities.yaml
    pub fn load() -> Result<Self, ConfigError>;
    
    /// Save to disk
    pub fn save(&self) -> Result<(), ConfigError>;
    
    /// Update capabilities for a hive
    pub fn update_hive(&mut self, alias: &str, caps: HiveCapabilities);
    
    /// Get capabilities for a hive
    pub fn get(&self, alias: &str) -> Option<&HiveCapabilities>;
}

pub struct HiveCapabilities {
    pub alias: String,
    pub devices: Vec<DeviceInfo>,
    pub last_updated_ms: i64,
}

pub struct DeviceInfo {
    pub id: String,
    pub name: String,
    pub vram_gb: u32,
    pub compute_capability: String,
}
```

### 1.4 SSH Config Parser

**Parser requirements:**
- Support SSH config syntax (Host, HostName, Port, User, etc.)
- Support custom fields (HivePort, BinaryPath)
- Support comments (`#`)
- Ignore unknown fields gracefully
- Validate required fields per host

**Recommended approach:**
- Use `ssh2-config` crate OR
- Write custom parser (SSH config is simple key-value)

**Example parser logic:**
```rust
fn parse_hives_conf(content: &str) -> Result<HashMap<String, HiveEntry>, ConfigError> {
    let mut hives = HashMap::new();
    let mut current_host: Option<String> = None;
    let mut current_entry = HiveEntry::default();
    
    for line in content.lines() {
        let line = line.trim();
        
        // Skip comments and empty lines
        if line.is_empty() || line.starts_with('#') {
            continue;
        }
        
        // Parse key-value pairs
        if line.starts_with("Host ") {
            // Save previous host if exists
            if let Some(alias) = current_host.take() {
                hives.insert(alias, current_entry);
                current_entry = HiveEntry::default();
            }
            
            // Start new host
            current_host = Some(line[5..].trim().to_string());
        } else if let Some(alias) = &current_host {
            // Parse host properties
            let parts: Vec<&str> = line.splitn(2, ' ').collect();
            if parts.len() == 2 {
                match parts[0] {
                    "HostName" => current_entry.hostname = parts[1].trim().to_string(),
                    "Port" => current_entry.ssh_port = parts[1].trim().parse()?,
                    "User" => current_entry.ssh_user = parts[1].trim().to_string(),
                    "HivePort" => current_entry.hive_port = parts[1].trim().parse()?,
                    "BinaryPath" => current_entry.binary_path = Some(parts[1].trim().to_string()),
                    _ => {} // Ignore unknown fields
                }
            }
        }
    }
    
    // Save last host
    if let Some(alias) = current_host {
        hives.insert(alias, current_entry);
    }
    
    Ok(hives)
}
```

### 1.5 Write Tests

**Test fixtures:**
- `tests/fixtures/valid_hives.conf` - Valid config with 3 hosts
- `tests/fixtures/invalid_hives.conf` - Duplicate aliases
- `tests/fixtures/sample_capabilities.yaml` - Sample capabilities

**Test cases:**
1. âœ… Parse valid hives.conf
2. âœ… Detect duplicate aliases
3. âœ… Handle missing required fields
4. âœ… Load and save capabilities.yaml
5. âœ… Validate config directory creation
6. âœ… Handle missing config files gracefully

### 1.6 Update Workspace

**In root `Cargo.toml`:**
```toml
[workspace]
members = [
    # ... existing members
    "bin/15_queen_rbee_crates/rbee-config",
]
```

---

## Acceptance Criteria

- [ ] `rbee-config` crate compiles without errors
- [ ] SSH config parser handles valid and invalid inputs
- [ ] All tests pass (`cargo test -p rbee-config`)
- [ ] Config directory is created if missing
- [ ] Duplicate alias detection works
- [ ] Capabilities cache can be loaded/saved
- [ ] README.md documents the API

---

## Verification Commands

```bash
# Create crate
cargo new --lib bin/15_queen_rbee_crates/rbee-config

# Add dependencies
cd bin/15_queen_rbee_crates/rbee-config
cargo add anyhow serde serde_yaml toml

# Build
cargo build -p rbee-config

# Test
cargo test -p rbee-config

# Check
cargo clippy -p rbee-config
```

---

## Handoff to TEAM-189

**What's ready:**
- âœ… `rbee-config` crate with SSH config parser
- âœ… API for loading hives.conf and capabilities.yaml
- âœ… Validation functions for uniqueness checks

**Next steps:**
- Replace SQLite calls in `job_router.rs` with `rbee-config` API
- Update Operation enum to use aliases instead of full SSH params

---

**Created by:** TEAM-187  
**For:** TEAM-188  
**Status:** ðŸ“‹ Ready to implement
