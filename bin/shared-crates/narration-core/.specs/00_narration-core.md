# Narration Core Specification

**Version**: 0.1.0  
**Status**: Draft  
**License**: GPL-3.0-or-later  
**Crate**: `bin/shared-crates/narration-core`

---

## Overview

The narration-core crate provides structured observability for llama-orch with human-readable narration, cute mode, story mode, and automatic secret redaction.

---

## Normative Requirements

### Core Narration (NARR-1000 series)

**NARR-1001**: The system MUST emit structured narration events with actor, action, target, and human fields.

**NARR-1002**: The system MUST support 7 logging levels: MUTE, TRACE, DEBUG, INFO, WARN, ERROR, FATAL.

**NARR-1003**: The system MUST automatically redact secrets in narration events.

**NARR-1004**: The system MUST support optional cute field for whimsical narration (â‰¤150 characters).

**NARR-1005**: The system MUST support optional story field for dialogue-based narration (â‰¤200 characters).

**NARR-1006**: The human field SHOULD be â‰¤100 characters for readability.

**NARR-1007**: The system MUST use present tense for in-progress actions and past tense for completed actions.

### Correlation IDs (NARR-2000 series)

**NARR-2001**: The system MUST generate UUID v4 correlation IDs.

**NARR-2002**: The system MUST validate correlation IDs in <100ns.

**NARR-2003**: The system MUST propagate correlation IDs across service boundaries via HTTP headers.

**NARR-2004**: The system MUST accept correlation IDs in `X-Correlation-Id` HTTP header.

**NARR-2005**: The system MUST emit correlation IDs in `X-Correlation-Id` HTTP header for downstream services.

### Redaction (NARR-3000 series)

**NARR-3001**: The system MUST redact bearer tokens matching pattern `Bearer\s+[A-Za-z0-9_-]+`.

**NARR-3002**: The system MUST redact API keys matching pattern `api[_-]?key[=:]\s*[A-Za-z0-9_-]+`.

**NARR-3003**: The system MUST redact JWT tokens matching pattern `eyJ[A-Za-z0-9_-]+\.eyJ[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+`.

**NARR-3004**: The system MUST redact private keys matching pattern `-----BEGIN.*PRIVATE KEY-----`.

**NARR-3005**: The system MUST redact URL passwords matching pattern `://[^:]+:[^@]+@`.

**NARR-3006**: The system MAY redact UUIDs when configured via `RedactionPolicy`.

**NARR-3007**: Redaction patterns MUST use bounded quantifiers to prevent ReDoS attacks.

**NARR-3008**: Redaction patterns MUST be cached using `OnceLock` for performance.

### Unicode Safety (NARR-4000 series)

**NARR-4001**: The system MUST provide ASCII fast path for zero-copy string handling.

**NARR-4002**: The system MUST sanitize CRLF characters (`\n`, `\r`, `\t`) from narration text.

**NARR-4003**: The system MUST reject non-ASCII actor names to prevent homograph attacks.

**NARR-4004**: The system MUST reject non-ASCII action names to prevent homograph attacks.

**NARR-4005**: The system MUST filter zero-width characters (U+200B, U+200C, U+200D, U+FEFF, U+2060).

### Performance (NARR-5000 series)

**NARR-5001**: Correlation ID validation MUST complete in <100ns (byte-level, no regex).

**NARR-5002**: Production builds MUST have zero overhead via conditional compilation.

**NARR-5003**: ASCII fast path MUST complete in <1Î¼s for typical strings.

**NARR-5004**: CRLF sanitization MUST complete in <50ns for clean strings (zero-copy).

**NARR-5005**: Redaction of clean strings (no secrets) MUST complete in <1Î¼s.

**NARR-5006**: Redaction of strings with secrets MUST complete in <5Î¼s.

**NARR-5007**: Trace macros MUST compile to no-ops when `trace-enabled` feature is disabled.

### Testing (NARR-6000 series)

**NARR-6001**: The system MUST provide a test capture adapter for observing narration events.

**NARR-6002**: The capture adapter MUST support assertions on captured events.

**NARR-6003**: Tests MUST emit proof bundles per monorepo standard (PB-1001..PB-1011).

**NARR-6004**: Tests MUST respect `LLORCH_RUN_ID` and `LLORCH_PROOF_DIR` environment variables.

**NARR-6005**: Proof bundles MUST include autogenerated headers per PB-1012.

**NARR-6006**: All tests MUST reference requirement IDs in comments.

### Auto-Injection (NARR-7000 series)

**NARR-7001**: The system MUST provide `narrate_auto()` for automatic provenance injection.

**NARR-7002**: Auto-injection MUST add `emitted_by` field with service identity.

**NARR-7003**: Auto-injection MUST add `emitted_at_ms` field with current timestamp.

**NARR-7004**: Auto-injection MUST NOT override existing `emitted_by` or `emitted_at_ms` fields.

**NARR-7005**: Service identity MUST include crate name and version (format: `crate@version`).

### Proc Macros (NARR-8000 series)

**NARR-8001**: The system MUST provide `#[trace_fn]` attribute macro for automatic function tracing.

**NARR-8002**: `#[trace_fn]` MUST support both sync and async functions.

**NARR-8003**: `#[trace_fn]` MUST measure function execution time.

**NARR-8004**: `#[trace_fn]` MUST compile to no-op when `trace-enabled` feature is disabled.

**NARR-8005**: The system SHOULD provide `#[narrate(...)]` attribute macro for template-based narration.

---

## Verification Plan

| Requirement | Test Type | Test ID | Location |
|-------------|-----------|---------|----------|
| NARR-1001 | Integration | test_narration_basic | tests/integration.rs:10 |
| NARR-1002 | BDD | levels.feature | bdd/features/levels.feature |
| NARR-1003 | Unit | test_redaction_in_narration | tests/integration.rs:45 |
| NARR-1004 | BDD | cute_mode.feature | bdd/features/cute_mode.feature |
| NARR-1005 | BDD | story_mode.feature | bdd/features/story_mode.feature |
| NARR-1006 | Manual | N/A | Enforced by convention |
| NARR-1007 | Manual | N/A | Enforced by convention |
| NARR-2001 | Unit | test_generate_correlation_id | src/correlation.rs:80 |
| NARR-2002 | Unit | test_validate_correlation_id | src/correlation.rs:90 |
| NARR-2003 | Integration | test_correlation_id_propagation | tests/integration.rs:34 |
| NARR-2004 | Unit | test_from_header | src/correlation.rs:100 |
| NARR-2005 | Unit | test_propagate | src/correlation.rs:110 |
| NARR-3001 | Unit | test_redact_bearer_token | src/redaction.rs:150 |
| NARR-3002 | Unit | test_redact_api_key | src/redaction.rs:160 |
| NARR-3003 | Unit | test_redact_jwt_token | src/redaction.rs:170 |
| NARR-3004 | Unit | test_redact_private_key | src/redaction.rs:180 |
| NARR-3005 | Unit | test_redact_url_password | src/redaction.rs:190 |
| NARR-3006 | Unit | test_uuid_redaction_when_enabled | src/redaction.rs:200 |
| NARR-3007 | Code Review | N/A | Verified in src/redaction.rs |
| NARR-3008 | Code Review | N/A | Verified in src/redaction.rs |
| NARR-4001 | Unit | test_sanitize_for_json_ascii_fast_path | src/unicode.rs:90 |
| NARR-4002 | Unit | test_sanitize_crlf_with_newlines | src/unicode.rs:120 |
| NARR-4003 | Unit | test_validate_actor_non_ascii | src/unicode.rs:140 |
| NARR-4004 | Unit | test_validate_action_non_ascii | src/unicode.rs:160 |
| NARR-4005 | Unit | test_sanitize_for_json_removes_zero_width | src/unicode.rs:100 |
| NARR-5001 | Benchmark | correlation_validation | benches/narration_benchmarks.rs |
| NARR-5002 | CI | production_build | CI verification |
| NARR-5003 | Benchmark | ascii_fast_path | benches/narration_benchmarks.rs |
| NARR-5004 | Benchmark | crlf_sanitization | benches/narration_benchmarks.rs |
| NARR-5005 | Benchmark | redaction_clean | benches/narration_benchmarks.rs |
| NARR-5006 | Benchmark | redaction_with_secrets | benches/narration_benchmarks.rs |
| NARR-5007 | CI | trace_disabled | CI verification |
| NARR-6001 | Unit | test_capture_adapter_basic | src/capture.rs:250 |
| NARR-6002 | Unit | test_assert_includes | src/capture.rs:260 |
| NARR-6003 | Integration | All tests | tests/integration.rs (pending) |
| NARR-6004 | Integration | All tests | tests/integration.rs (pending) |
| NARR-6005 | Integration | All tests | tests/integration.rs (pending) |
| NARR-6006 | Code Review | N/A | Verified in test files |
| NARR-7001 | Unit | test_narrate_auto_injects_fields | src/auto.rs:160 |
| NARR-7002 | Unit | test_narrate_auto_injects_fields | src/auto.rs:160 |
| NARR-7003 | Unit | test_narrate_auto_injects_fields | src/auto.rs:160 |
| NARR-7004 | Unit | test_narrate_auto_respects_existing_fields | src/auto.rs:195 |
| NARR-7005 | Unit | test_service_identity | src/auto.rs:144 |
| NARR-8001 | Unit | N/A | Implemented in narration-macros |
| NARR-8002 | Unit | N/A | Implemented in narration-macros |
| NARR-8003 | Unit | N/A | Implemented in narration-macros |
| NARR-8004 | CI | N/A | Verified via conditional compilation |
| NARR-8005 | Unit | N/A | Foundation in narration-macros |

---

## Acceptance Criteria

- [x] All MUST requirements have passing tests or documented exceptions
- [x] All SHOULD requirements have tests or documented rationale
- [x] All MAY requirements are documented
- [x] Verification plan maps all requirements to tests
- [x] All tests reference requirement IDs in comments
- [ ] All integration tests emit proof bundles (pending)
- [ ] 100% test pass rate (40/41 unit tests passing, 1 flaky)

---

## Known Issues

### Flaky Tests (NARR-7001, NARR-7004)

**Issue**: `CaptureAdapter` uses global `OnceLock` causing race conditions in tests.

**Tests Affected**:
- `test_narrate_auto_injects_fields` (passes individually, flaky in suite)
- `test_narrate_auto_respects_existing_fields` (passes individually, flaky in suite)

**Mitigation**: Tests annotated with `#[serial(capture_adapter)]` to force sequential execution.

**Status**: Partial fix applied. Tests pass individually but still flaky when run together.

**Future Fix**: Refactor `CaptureAdapter` to use thread-local storage instead of global state.

---

## Non-Normative Guidance

### Cute Mode Guidelines

- Use whimsical metaphors (VRAM = "cozy blanket", GPU = "friendly helper")
- Include emoji (ðŸ›ï¸, âœ¨, ðŸ˜Ÿ, ðŸ , ðŸ‘‹, ðŸ”, ðŸ’ª, ðŸŽ‰)
- Keep under 150 characters
- NO dialogue (save that for story mode)

### Story Mode Guidelines

- Use dialogue format with quotes
- Include speaker attribution ("asked", "replied", "announced")
- Show multi-service interactions
- Keep under 200 characters
- Use for request/response flows, heartbeats, negotiations

### Human Field Guidelines

- Use present tense for in-progress ("Spawning engine")
- Use past tense for completed ("Spawned engine")
- Include specific numbers and IDs
- Keep under 100 characters
- Avoid cryptic abbreviations
- Avoid passive voice

---

## References

- **Proof Bundle Standard**: `libs/proof-bundle/.specs/00_proof-bundle.md` (PB-1001..PB-1011)
- **Monorepo Workflow**: `README_LLM.md` (Specâ†’Contractâ†’Testsâ†’Code)
- **BDD Runner**: `test-harness/bdd` binary `bdd-runner`
- **Testing Standards**: `.docs/testing/`

---

**Specification Status**: Draft  
**Last Updated**: 2025-10-04  
**Next Review**: After remediation complete
