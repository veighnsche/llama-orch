# Testing & CI Policy â€” Home Profile
This project treats tests as the contract. Follow these rules whenever you add or modify tests.
## Core Principle
- The product (orchestrator + services) must exercise all state changes. Tests may seed inputs but cannot bypass handlers or mutate internal state directly.
## Skip Policy
- No `#[ignore]` or conditional skips in committed code. If a test is flaky or blocked, fix it or file a blocking issue and mark it TODO for immediate follow-up.
- If an environment constraint prevents a suite from running (e.g., GPU not available), fail with a clear message rather than skipping silently.
## CI Matrix
- Default CI runs on Linux with access to a mock adapter. GPU-required suites (determinism, Haiku, reference smoke) are triggered manually or in dedicated jobs; they must still pass before release.
- Future matrix jobs (different toolchains or OS variants) must run the same assertions. No gating by distro unless explicitly unsupported.
## Harness Guidelines
- Harnesses must call public APIs only (HTTP handlers, CLI). Avoid reaching into private state.
- Do not mutate binaries or install system packages inside tests unless the test itself exercises installer logic.
- When using tunnels (for remote dev box simulation), document setup steps in `.docs/HOME_PROFILE_TARGET.md`.
## Proof Bundle
- Every test type must emit a crate-local  under `<crate>/.proof_bundle/<type>/<run_id>/` as defined in `.docs/testing/TEST_TYPES_GUIDE.md`.
- Tests must write the required artifacts defined by `.proof_bundle/templates/*/README.md` and the per-type guides under `.docs/testing/types/*.md`.
- Prefer `run_id` format `YYYYMMDD-HHMMSS-<git_sha8>`; respect `LLORCH_RUN_ID` and `LLORCH_PROOF_DIR` when set.
- All generated artifacts MUST include the required autogenerated header per `.proof_bundle/README.md` and `.docs/testing/TEST_TYPES_GUIDE.md` (format-appropriate: header line for Markdown/CSV/text; first metadata record for NDJSON; sibling `.meta` or embedded field for JSON).
- When implementing features, capture the following artifacts (in addition to the per-type required files):
  - Pact diffs (`cli/consumer-tests`)
  - Provider verify output (`orchestratord/tests/provider_verify.rs`)
  - BDD transcripts (`test-harness/bdd` logs)
  - Metrics dumps from `/metrics`
  - Determinism diffs when failures occur
  - SSE transcripts (with and without micro-batching) and narration coverage excerpts
- Store or link artifacts in PR descriptions or issue trackers; do not rely on ephemeral console logs.
## Release Gates
- Before tagging a release, run:
  - `cargo xtask dev:loop`
  - `cargo test -p test-harness-bdd -- --nocapture`
  - `cargo test -p test-harness-determinism-suite`
  - `cargo test -p test-harness-e2e-haiku` (with real GPU)
  - Reference environment smoke (script TBD) on the workstation described in `.docs/HOME_PROFILE_TARGET.md`
## Documentation
- Update `.docs/testing/spec-derived-test-catalog.md` and `.docs/testing/spec-combination-matrix.md` whenever new requirements or tests are added.
- Record new harness behaviours in `BDD_WIRING.md` or module-level docs.
Follow these policies to keep the home lab product dependable.
