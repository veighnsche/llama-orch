FROM rust:1.75-slim

# Install SSH server, git, and build tools
RUN apt-get update && apt-get install -y \
    openssh-server \
    git \
    build-essential \
    pkg-config \
    libssl-dev \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Setup SSH
RUN mkdir -p /var/run/sshd
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
RUN sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config

# Create test user
RUN useradd -m -s /bin/bash rbee
RUN echo 'rbee:rbee' | chpasswd

# Setup SSH keys for passwordless auth
RUN mkdir -p /home/rbee/.ssh
COPY tests/docker/keys/test_id_rsa.pub /home/rbee/.ssh/authorized_keys
RUN chown -R rbee:rbee /home/rbee/.ssh
RUN chmod 700 /home/rbee/.ssh
RUN chmod 600 /home/rbee/.ssh/authorized_keys

WORKDIR /home/rbee
USER rbee

EXPOSE 22
