FROM archlinux:latest AS base

# Install SSH server, git, Rust, and build tools
RUN pacman -Syu --noconfirm \
    openssh \
    git \
    base-devel \
    openssl \
    curl \
    supervisor \
    && pacman -Scc --noconfirm

# Setup SSH
RUN ssh-keygen -A
RUN mkdir -p /var/run/sshd  
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
RUN sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config

# Create test user
RUN useradd -m -s /bin/bash rbee
RUN echo 'rbee:rbee' | chpasswd

# Setup SSH keys for passwordless auth
RUN mkdir -p /home/rbee/.ssh
COPY tests/docker/keys/test_id_rsa.pub /home/rbee/.ssh/authorized_keys
RUN chown -R rbee:rbee /home/rbee/.ssh
RUN chmod 700 /home/rbee/.ssh
RUN chmod 600 /home/rbee/.ssh/authorized_keys

RUN mkdir -p /home/rbee/.local/bin /home/rbee/.config/rbee /home/rbee/.local/share/rbee
USER rbee

# Copy pre-built rbee-hive binary
COPY --chown=rbee:rbee target/debug/rbee-hive /home/rbee/.local/bin/rbee-hive
RUN chmod +x /home/rbee/.local/bin/rbee-hive

USER root

# Setup supervisor config
COPY tests/docker/configs/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

EXPOSE 22 9000

CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
