# Test Harness Redesign Blueprint
**Version**: 0.3.0  
**Status**: Design Phase  
**Owner**: Testing Team  
**Last Updated**: 2025-10-02
---
## Executive Summary
The v0.1.0 test-harness was a monolithic, centralized testing structure that has become obsolete. This blueprint defines a **decentralized, crate-local testing architecture** aligned with v0.3.0 principles:
- **Unit tests** live in each crate's `tests/` directory
- **BDD tests** live in dedicated `<crate>/bdd/` subcrates
- **Integration tests** use standard Rust test organization
- **No centralized test-harness** — testing is distributed and owned by individual teams
---
## Problems with v0.1.0 test-harness
### 1. Centralization Anti-Pattern
- **Single monolithic crate** (`test-harness/bdd`) tried to test the entire monorepo
- **Tight coupling** — changes in any component broke the central harness
- **Ownership confusion** — unclear which team owns which tests
- **Slow feedback** — running all tests required full workspace build
### 2. Duplicate BDD Infrastructure
- **12+ BDD subcrates** already exist in `bin/*/bdd/` directories
- **test-harness/bdd** duplicated functionality already present in component crates
- **Inconsistent patterns** — some teams used local BDD, others used central harness
### 3. Poor Test Type Separation
- **Mixed concerns** — BDD, E2E, determinism, chaos, metrics all in one directory
- **Unclear boundaries** — which tests belong where?
- **Hard to run subsets** — no clear way to run just one test type
### 4. Maintenance Burden
- **Stale tests** — centralized tests lag behind component changes
- **Brittle** — single point of failure for all testing
- **Hard to extend** — adding new test types required central coordination
---
## Design Principles (v0.3.0)
### 1. Decentralized Testing
**Each crate owns its own tests.**
```
bin/rbees-orcd/
├── src/           # Production code
├── tests/         # Unit & integration tests
└── bdd/           # BDD subcrate (optional)
    ├── Cargo.toml
    ├── src/main.rs (bdd-runner binary)
    └── tests/features/
```
### 2. Test Type Clarity
**Clear separation by test type:**
- **Unit tests**: `<crate>/src/` (inline `#[cfg(test)]`) or `<crate>/tests/`
- **BDD tests**: `<crate>/bdd/` subcrate with cucumber features
- **Integration tests**: `<crate>/tests/` using standard Rust patterns
- **Property tests**: `<crate>/tests/` using proptest/quickcheck
- **Smoke tests**: `<crate>/tests/smoke/` for real-world scenarios
### 3. Team Ownership
**Testing follows crate ownership:**
| Team | Crates | Test Responsibility |
|------|--------|---------------------|
| Orchestrator Team | `bin/rbees-orcd`, `bin/rbees-orcd-crates/*` | Unit, BDD, integration tests for orchestrator logic |
| Pool Manager Team | `bin/pool-managerd`, `bin/pool-managerd-crates/*` | Unit, BDD, integration tests for pool management |
| Worker Team | `bin/worker-orcd`, `bin/worker-orcd-crates/*` | Unit, BDD, integration tests for worker logic |
| Shared Libs Team | `bin/shared-crates/*` | Unit, BDD tests for shared utilities |
| Testing Team | **This directory** | Cross-cutting test infrastructure,  tooling |
### 4. Proof Bundle Standard
**All tests emit standardized artifacts:**
- **Location**: `<crate>/.proof_bundle/<type>/<run_id>/`
- **Environment vars**: `LLORCH_RUN_ID`, `LLORCH_PROOF_DIR`
- **Shared crate**: `bin/shared-crates/` (to be created)
- **Spec**: `.docs/testing/PROOF_BUNDLE_SPEC.md`
---
## Redesigned Architecture
### Directory Structure
```
test-harness/
├── BLUEPRINT.md                    # This file
├── README.md                       # Overview of testing strategy
├── /                   # Shared  tooling
│   ├── Cargo.toml
│   ├── src/
│   │   ├── lib.rs                  # ProofBundle API
│   │   ├── types.rs                # TestType enum
│   │   ├── env.rs                  # Environment variable handling
│   │   └── writers/                # NDJSON, JSON, Markdown writers
│   └── tests/
└── test-utils/                     # Shared test utilities (optional)
    ├── Cargo.toml
    └── src/
        ├── fixtures.rs             # Common test fixtures
        ├── assertions.rs           # Custom assertions
        └── harness.rs              # Test harness helpers
```
### What Lives Here
#### 1. Proof Bundle Tooling (`/`)
**Shared library for test artifact generation.**
```rust
// Usage in any crate
use test_harness_proof_bundle::{ProofBundle, TestType};
#[test]
fn test_something() {
    let mut bundle = ProofBundle::for_type(TestType::Unit);
    // Record test data
    bundle.append_ndjson("events.ndjson", &event)?;
    bundle.write_json("summary.json", &summary)?;
    bundle.record_seed(42);
    // Artifacts written to <crate>/.proof_bundle/unit/<run_id>/
}
```
**Key features:**
- Respects `LLORCH_RUN_ID` and `LLORCH_PROOF_DIR`
- Enforces autogenerated headers (PB-1012)
- Supports NDJSON, JSON, Markdown, CSV
- Thread-safe, async-compatible
#### 2. Test Utilities (`test-utils/`, optional)
**Shared test helpers for common patterns.**
```rust
// Fixtures
use test_harness_utils::fixtures::{mock_orchestrator, sample_request};
// Assertions
use test_harness_utils::assertions::{assert_sse_stream, assert_metrics_valid};
// Harness
use test_harness_utils::harness::TestOrchestrator;
```
**Only create if genuinely reusable across 3+ crates.**
---
## Migration Strategy
### Phase 1: Proof Bundle Extraction (Week 1)
**Goal**: Create shared  crate
- [ ] Create `test-harness//` crate
- [ ] Extract  logic from existing BDD crates
- [ ] Update all BDD subcrates to use shared crate
- [ ] Document  API in `test-harness//README.md`
### Phase 2: Test Type Consolidation (Week 2)
**Goal**: Move specialized tests to appropriate crates
#### Determinism Tests
- **Old**: `test-harness/determinism-suite/`
- **New**: `bin/rbees-orcd/tests/determinism/`
- **Rationale**: Determinism is an orchestrator property
#### Chaos Tests
- **Old**: `test-harness/chaos/`
- **New**: `bin/rbees-orcd/tests/chaos/` or `bin/pool-managerd/tests/chaos/`
- **Rationale**: Chaos tests target specific components
#### E2E Haiku Tests
- **Old**: `test-harness/e2e-haiku/`
- **New**: `bin/rbees-orcd/tests/e2e/` or dedicated `e2e-tests/` crate
- **Rationale**: E2E tests exercise full stack, could be separate
#### Metrics Contract Tests
- **Old**: `test-harness/metrics-contract/`
- **New**: `bin/shared-crates/metrics-validation/` (new crate)
- **Rationale**: Metrics validation is cross-cutting, deserves dedicated crate
### Phase 3: Documentation & Cleanup (Week 3)
- [ ] Update `.docs/testing/TESTING_POLICY.md`
- [ ] Create `test-harness/README.md` explaining new architecture
- [ ] Update all crate READMEs with testing sections
- [ ] Remove references to old test-harness in docs
- [ ] Update CI pipelines to run distributed tests
---
## Testing Patterns by Type
### Unit Tests
**Location**: `<crate>/src/` or `<crate>/tests/`
```rust
// Inline (preferred for small tests)
#[cfg(test)]
mod tests {
    use super::*;
    #[test]
    fn test_queue_enqueue() {
        let mut queue = Queue::new();
        queue.enqueue(job);
        assert_eq!(queue.len(), 1);
    }
}
// Separate file (for larger test suites)
// <crate>/tests/queue_tests.rs
use my_crate::Queue;
#[test]
fn test_queue_capacity() {
    // ...
}
```
### BDD Tests
**Location**: `<crate>/bdd/`
```
<crate>/bdd/
├── Cargo.toml              # name = "<crate>-bdd"
├── src/
│   ├── main.rs             # bdd-runner binary
│   └── lib.rs              # World and step definitions
└── tests/
    └── features/
        └── *.feature       # Gherkin scenarios
```
**Example Cargo.toml:**
```toml
[package]
name = "rbees-orcd-bdd"
version.workspace = true
edition.workspace = true
license.workspace = true
[[bin]]
name = "bdd-runner"
path = "src/main.rs"
[dependencies]
cucumber = { version = "0.20", features = ["macros"] }
rbees-orcd = { path = ".." }
```
**Run BDD tests:**
```bash
# All features
cargo run -p rbees-orcd-bdd --bin bdd-runner
# Specific feature
LLORCH_BDD_FEATURE_PATH=tests/features/enqueue.feature \
  cargo run -p rbees-orcd-bdd --bin bdd-runner
```
### Integration Tests
**Location**: `<crate>/tests/`
```rust
// <crate>/tests/integration_test.rs
use rbees-orcd::Orchestrator;
use pool_managerd::PoolManager;
#[tokio::test]
async fn test_full_workflow() {
    let orch = Orchestrator::start().await?;
    let pool = PoolManager::start().await?;
    // Test orchestrator + pool interaction
    let job_id = orch.enqueue(request).await?;
    let status = orch.get_status(&job_id).await?;
    assert_eq!(status.state, JobState::Completed);
}
```
### Property Tests
**Location**: `<crate>/tests/`
```rust
use proptest::prelude::*;
proptest! {
    #[test]
    fn test_queue_invariants(jobs in prop::collection::vec(any::<Job>(), 0..100)) {
        let mut queue = Queue::new();
        for job in jobs {
            queue.enqueue(job);
        }
        // Queue size matches enqueued jobs
        assert_eq!(queue.len(), jobs.len());
    }
}
```
### Smoke Tests
**Location**: `<crate>/tests/smoke/`
```rust
// <crate>/tests/smoke/tinyllama.rs
#[tokio::test]
#[ignore] // Requires GPU
async fn smoke_test_tinyllama() {
    let orch = Orchestrator::start().await?;
    let request = EnqueueRequest {
        model: "TinyLlama-1.1B-Chat-v1.0".to_string(),
        prompt: "Hello, world!".to_string(),
        max_tokens: 10,
        seed: Some(42),
        ..Default::default()
    };
    let tokens = orch.enqueue_and_collect(request).await?;
    assert!(!tokens.is_empty());
}
```
---
## Cross-Cutting Test Infrastructure
### What the Testing Team Owns
#### 1. Proof Bundle Standard
- **Crate**: `test-harness//`
- **Responsibility**: Shared library for test artifact generation
- **Consumers**: All crates with tests
#### 2. Test Utilities (Optional)
- **Crate**: `test-harness/test-utils/`
- **Responsibility**: Genuinely reusable test helpers
- **Consumers**: 3+ crates (only create if needed)
#### 3. Metrics Validation
- **Crate**: `bin/shared-crates/metrics-validation/` (new)
- **Responsibility**: Prometheus metrics contract enforcement
- **Consumers**: All services that emit metrics
#### 4. E2E Test Suite (Optional)
- **Crate**: `e2e-tests/` (top-level, optional)
- **Responsibility**: Full-stack integration tests
- **Consumers**: CI/CD, release gates
### What the Testing Team Does NOT Own
- **Component unit tests** — owned by component teams
- **Component BDD tests** — owned by component teams
- **Component integration tests** — owned by component teams
- **Performance tests** — owned by component teams (with shared tooling)
---
## CI/CD Integration
### Distributed Test Execution
```yaml
# .github/workflows/test.yml
name: Tests
on: [push, pull_request]
jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run all unit tests
        run: cargo test --workspace --lib --bins
  bdd-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        crate:
          - rbees-orcd-bdd
          - pool-managerd-bdd
          - orchestrator-core-bdd
          - model-catalog-bdd
          # ... all BDD crates
    steps:
      - uses: actions/checkout@v3
      - name: Run BDD tests for ${{ matrix.crate }}
        run: cargo run -p ${{ matrix.crate }} --bin bdd-runner
  integration-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run integration tests
        run: cargo test --workspace --tests
  smoke-tests:
    runs-on: gpu-runner
    steps:
      - uses: actions/checkout@v3
      - name: Download TinyLlama
        run: ./scripts/download-test-models.sh
      - name: Run smoke tests
        run: cargo test --workspace --tests -- --ignored --nocapture
```
### Test Organization by Speed
```bash
# Fast tests (run on every commit)
cargo test --workspace --lib --bins
# Medium tests (run on PR)
cargo test --workspace --tests
# Slow tests (run on merge to main)
cargo test --workspace --tests -- --ignored
# GPU tests (run manually or nightly)
cargo test --workspace --tests -- --ignored smoke_test
```
---
## Developer Workflow
### Running Tests Locally
```bash
# Run all tests for a single crate
cd bin/rbees-orcd
cargo test
# Run BDD tests for a crate
cargo run -p rbees-orcd-bdd --bin bdd-runner
# Run specific test
cargo test -p rbees-orcd -- test_enqueue
# Run with 
LLORCH_PROOF_DIR=.proof_bundle cargo test
# Run smoke tests (requires GPU)
cargo test -- --ignored smoke_test
```
### Adding a New Test
1. **Identify test type**: Unit, BDD, integration, property, smoke?
2. **Find appropriate location**: `<crate>/src/`, `<crate>/tests/`, or `<crate>/bdd/`
3. **Write test** following patterns above
4. **Use ** if generating artifacts
5. **Update crate README** with test documentation
### Creating a BDD Subcrate
```bash
# Create BDD subcrate
mkdir -p bin/my-crate/bdd
cd bin/my-crate/bdd
# Create Cargo.toml
cat > Cargo.toml << 'EOF'
[package]
name = "my-crate-bdd"
version.workspace = true
edition.workspace = true
license.workspace = true
[[bin]]
name = "bdd-runner"
path = "src/main.rs"
[dependencies]
cucumber = { version = "0.20", features = ["macros"] }
my-crate = { path = ".." }
EOF
# Create main.rs
mkdir -p src
cat > src/main.rs << 'EOF'
use cucumber::World;
#[derive(Debug, Default, World)]
pub struct MyWorld {
    // Test state
}
#[tokio::main]
async fn main() {
    MyWorld::cucumber()
        .fail_on_skipped()
        .run_and_exit("tests/features")
        .await;
}
EOF
# Create feature directory
mkdir -p tests/features
# Add to workspace
cd ../../..
# Edit Cargo.toml to add "bin/my-crate/bdd"
```
---
## Proof Bundle Integration
### Standard Usage
```rust
use test_harness_proof_bundle::{ProofBundle, TestType};
#[test]
fn test_with_proof_bundle() {
    let mut bundle = ProofBundle::for_type(TestType::Unit);
    // Test logic
    let result = my_function();
    // Record artifacts
    bundle.append_ndjson("events.ndjson", &event)?;
    bundle.write_json("result.json", &result)?;
    bundle.record_seed(42);
    // Assertions
    assert!(result.is_ok());
}
```
### BDD Integration
```rust
use cucumber::{given, when, then, World};
use test_harness_proof_bundle::{ProofBundle, TestType};
#[derive(Debug, World)]
pub struct MyWorld {
    bundle: ProofBundle,
    // ... other state
}
impl Default for MyWorld {
    fn default() -> Self {
        Self {
            bundle: ProofBundle::for_type(TestType::Bdd),
        }
    }
}
#[when("I perform action")]
async fn when_action(world: &mut MyWorld) {
    let result = perform_action().await;
    world.bundle.append_ndjson("actions.ndjson", &result)?;
}
```
---
## Success Criteria
### Phase 1 Complete When:
- [ ] `test-harness//` crate exists and compiles
- [ ] All BDD subcrates use shared  crate
- [ ]  spec documented in `test-harness//README.md`
- [ ] CI runs  validation
### Phase 2 Complete When:
- [ ] Determinism tests moved to `bin/rbees-orcd/tests/determinism/`
- [ ] Chaos tests moved to appropriate component crates
- [ ] E2E tests moved to `bin/rbees-orcd/tests/e2e/` or dedicated crate
- [ ] Metrics contract tests in `bin/shared-crates/metrics-validation/`
- [ ] Old `test-harness/` directory deleted (except )
### Phase 3 Complete When:
- [ ] All documentation updated
- [ ] CI pipelines run distributed tests
- [ ] Developer workflow documented
- [ ] All teams trained on new patterns
---
## Open Questions
1. **E2E Test Location**: Should E2E tests live in `bin/rbees-orcd/tests/e2e/` or a dedicated top-level `e2e-tests/` crate?
   - **Recommendation**: Start in `bin/rbees-orcd/tests/e2e/`, extract if it grows large
2. **Test Utils Necessity**: Do we need `test-harness/test-utils/`?
   - **Recommendation**: Wait until 3+ crates need the same helper, then extract
3. **Performance Tests**: Where do performance/load tests live?
   - **Recommendation**: Component-local (`<crate>/tests/perf/`) with shared tooling in `test-harness/perf-utils/` if needed
4. **Contract Tests**: Where do Pact/OpenAPI contract tests live?
   - **Recommendation**: `contracts/api-types/tests/` for API contract validation
---
## References
- `.docs/testing/TESTING_POLICY.md` — Testing policy and  requirements
- `.docs/testing/BDD_WIRING.md` — BDD wiring patterns
- `README.md` (workspace root) — Developer quickstart
- Memory: `MEMORY[c5829818-9430-4732-9061-35bda3490df4]` —  crate creation
- Memory: `MEMORY[1465a2c9-47ad-4800-8c5f-da2a4cf3ce02]` — BDD runner binary pattern
---
## Appendix: Comparison
### Before (v0.1.0)
```
test-harness/
├── bdd/                    # Centralized BDD for everything
├── determinism-suite/      # Determinism tests
├── chaos/                  # Chaos tests
├── e2e-haiku/              # E2E tests
└── metrics-contract/       # Metrics validation
```
**Problems:**
- Centralized, monolithic
- Unclear ownership
- Slow feedback
- Duplicate infrastructure
### After (v0.3.0)
```
test-harness/
├── BLUEPRINT.md            # This file
├── README.md               # Testing overview
└── /           # Shared  tooling
bin/rbees-orcd/
├── src/
├── tests/                  # Unit, integration, determinism, chaos, e2e
└── bdd/                    # BDD subcrate
bin/pool-managerd/
├── src/
├── tests/                  # Unit, integration
└── bdd/                    # BDD subcrate
bin/shared-crates/metrics-validation/
├── src/                    # Metrics contract validation
└── tests/
```
**Benefits:**
- Decentralized, component-local
- Clear ownership
- Fast feedback
- Minimal duplication
