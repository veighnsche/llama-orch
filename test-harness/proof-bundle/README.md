# proof-bundle

**Test artifact standardization library**

`libs/proof-bundle` — Utilities to emit standardized proof bundles for test artifacts (NDJSON, JSON, Markdown, seeds).

---

## What This Library Does

proof-bundle provides **standardized test artifact output** for llama-orch:

- **Proof bundle structure** — Standard directory layout per test type
- **Automatic cleanup** — Keeps only the latest bundle per test type (removes old ones)
- **NDJSON output** — Append-only JSON lines for streaming data
- **JSON output** — Pretty-printed JSON for metadata
- **Markdown output** — Test reports and summaries
- **Seed tracking** — Record random seeds for reproducibility
- **Environment overrides** — `LLORCH_PROOF_DIR`, `LLORCH_RUN_ID`

**Used by**: All test harnesses (BDD, determinism, chaos, E2E)

---

## ⚠️ Design: Synchronous I/O (Test-Time Only)

This library uses **synchronous I/O** (`std::fs`) by design:

- ✅ **Test-time only**: Not used in production runtime
- ✅ **Small operations**: Fast file writes (< 1ms)
- ✅ **Simple API**: No `.await` noise in test code
- ✅ **No async conflicts**: Works in any test context
- ✅ **No tokio dependency**: Pure `std::fs`

**Do not use in async production code.** This library is for test artifact generation only.

---

## Cleanup Policy

**Only the latest proof bundle is kept per test type.**

When `ProofBundle::for_type()` is called:
1. **Before** creating the new bundle: All existing bundles in that test type directory are deleted
2. **Then** the new bundle is created with the current run ID
3. **Result**: Only ONE bundle per test type exists at any time

### Example

```bash
# BEFORE test run:
.proof_bundle/unit/20251002-120000-abc123/  ← OLD, will be deleted
.proof_bundle/unit/20251002-115000-def456/  ← OLD, will be deleted

# AFTER test run:
.proof_bundle/unit/20251002-123000-xyz789/  ← NEW, only this remains
```

This prevents proof bundle directories from accumulating and clogging the repository.

---

## Directory Structure

### Standard Path

```
<crate>/.proof_bundle/<type>/<run_id>/
├── metadata.json
├── scenarios.ndjson
├── steps.ndjson
├── seeds.txt
└── report.md
```

### Example

```
test-harness/bdd/.proof_bundle/bdd/20251001-013000-abc12345/
├── metadata.json
├── scenarios.ndjson
├── steps.ndjson
├── seeds.txt
└── report.md
```

---

## Usage

### Add as Dependency

```toml
[dev-dependencies]
proof-bundle = { path = "../../libs/proof-bundle" }
```

### Basic Example

```rust
use proof_bundle::{ProofBundle, TestType};
use serde::Serialize;

#[derive(Serialize)]
struct Event {
    event: String,
    timestamp: u64,
}

#[test]
fn test_with_proof_bundle() -> anyhow::Result<()> {
    // Create proof bundle for integration tests
    let pb = ProofBundle::for_type(TestType::Integration)?;
    
    // Write metadata
    pb.write_json("metadata", &serde_json::json!({
        "test": "test_with_proof_bundle",
        "timestamp": 1696118400,
    }))?;
    
    // Append NDJSON events
    pb.append_ndjson("events", &Event {
        event: "started".to_string(),
        timestamp: 1696118400,
    })?;
    
    pb.append_ndjson("events", &Event {
        event: "completed".to_string(),
        timestamp: 1696118450,
    })?;
    
    // Write markdown report
    pb.write_markdown("report.md", 
        "# AUTOGENERATED: Proof Bundle\n\n## Test Results\n\nAll tests passed.\n"
    )?;
    
    // Record seed for reproducibility
    pb.seeds().record(42)?;
    
    Ok(())
}
```

---

## API Reference

### ProofBundle

```rust
impl ProofBundle {
    /// Create proof bundle for test type
    pub fn for_type(test_type: TestType) -> Result<Self>;
    
    /// Get bundle root directory
    pub fn root(&self) -> &Path;
    
    /// Ensure subdirectory exists
    pub fn ensure_dir(&self, sub: &str) -> Result<PathBuf>;
    
    /// Append NDJSON line
    pub fn append_ndjson<T: Serialize>(&self, name: &str, value: &T) -> Result<()>;
    
    /// Write pretty JSON
    pub fn write_json<T: Serialize>(&self, name: &str, value: &T) -> Result<()>;
    
    /// Write markdown file
    pub fn write_markdown(&self, name: &str, content: &str) -> Result<()>;
    
    /// Get seed tracker
    pub fn seeds(&self) -> SeedTracker;
}
```

### TestType

```rust
pub enum TestType {
    Unit,           // Unit tests
    Integration,    // Integration tests
    Contract,       // Contract tests (pacts)
    Bdd,            // BDD scenarios
    Determinism,    // Determinism validation
    Smoke,          // Smoke tests
    E2eHaiku,       // E2E GPU tests
}
```

### SeedTracker

```rust
impl SeedTracker {
    /// Record a seed value
    pub fn record(&self, seed: u64) -> Result<()>;
}
```

---

## Environment Variables

### LLORCH_RUN_ID

Override the run ID (default: `YYYYMMDD-HHMMSS-<git_sha8>`):

```bash
LLORCH_RUN_ID=20251001-custom cargo test
```

### LLORCH_PROOF_DIR

Override the proof bundle root directory:

```bash
LLORCH_PROOF_DIR=/tmp/proof cargo test
```

---

## NDJSON Format

### Metadata Header

Always start NDJSON files with a metadata record:

```rust
pb.append_ndjson("events", &serde_json::json!({
    "_meta": "proof_bundle",
    "_note": "autogenerated",
    "_timestamp": chrono::Utc::now().to_rfc3339(),
}))?;
```

### Event Records

```rust
pb.append_ndjson("events", &serde_json::json!({
    "type": "token",
    "text": "hello",
    "index": 0,
}))?;
```

---

## Markdown Format

### Required Header

All markdown files must start with the autogenerated header:

```markdown
# AUTOGENERATED: Proof Bundle

## Test Report

...
```

---

## Testing

### Unit Tests

```bash
# Run all tests
cargo test -p proof-bundle -- --nocapture

# Run specific test
cargo test -p proof-bundle -- test_proof_bundle --nocapture
```

### BDD Tests

```bash
# Run BDD scenarios
cargo test -p proof-bundle-bdd -- --nocapture
```

---

## Dependencies

### Internal

- None (foundational library)

### External

- `serde` — Serialization
- `serde_json` — JSON format
- `chrono` — Timestamps
- `anyhow` — Error handling

---

## Example: BDD Test

```rust
use proof_bundle::{ProofBundle, TestType};

#[test]
fn bdd_scenario() -> anyhow::Result<()> {
    let pb = ProofBundle::for_type(TestType::Bdd)?;
    
    // Metadata
    pb.write_json("metadata", &serde_json::json!({
        "feature": "task_admission",
        "scenario": "successfully_admit_task",
    }))?;
    
    // Scenario result
    pb.append_ndjson("scenarios", &serde_json::json!({
        "scenario": "successfully_admit_task",
        "status": "passed",
        "duration_ms": 150,
    }))?;
    
    // Steps
    pb.append_ndjson("steps", &serde_json::json!({
        "step": "Given orchestratord is running",
        "status": "passed",
    }))?;
    
    pb.append_ndjson("steps", &serde_json::json!({
        "step": "When I POST a task",
        "status": "passed",
    }))?;
    
    // Seed
    pb.seeds().record(12345)?;
    
    Ok(())
}
```

---

## Specifications

Implements requirements from:
- PB-1012 (Autogenerated headers)
- Test artifact standardization

---

## Status

- **Version**: 0.0.0 (early development)
- **License**: GPL-3.0-or-later
- **Stability**: Alpha
- **Maintainers**: @llama-orch-maintainers
