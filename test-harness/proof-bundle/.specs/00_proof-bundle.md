# Proof Bundle — Monorepo Standard (PB-1xxx)

Status: Draft
Owner: @llama-orch-maintainers
Date: 2025-09-26

## Purpose & Scope

Define a uniform, crate-local proof bundle standard and a reference support crate that tests can use to emit complete, reviewable artifacts without having to re-run tests. This spec is normative for:

- Location and naming of bundles
- Required environment variables and defaults
- File formats and extensions
- Minimal API surface of the support crate
- Mapping between test types and bundle directories

Out of scope:

- What each test type must capture functionally (covered in `.proof_bundle/templates/*/README.md` and `.docs/testing/types/*.md`)
- CI policies (covered by `.docs/testing/TESTING_POLICY.md`)

## Terminology

- Bundle Root: `<crate>/.proof_bundle/<type>/<run_id>/` unless overridden via environment.
- Test Type: one of `unit`, `integration`, `contract`, `bdd`, `determinism`, `home-profile-smoke`, `e2e-haiku`.
- Support Crate: `libs/proof-bundle` — provides APIs to write bundles.

## Normative Requirements

### PB-1001 Location & Naming

- The support crate MUST write bundles under the crate-local directory `<crate>/.proof_bundle/<type>/<run_id>/` by default.
- The `<type>` directory names MUST be:
  - `unit`, `integration`, `contract`, `bdd`, `determinism`, `home-profile-smoke`, `e2e-haiku`.
- The `<run_id>` MUST be a stable directory name for a given run; see PB-1002.

### PB-1002 Run ID Resolution

- The support crate MUST honor the environment variable `LLORCH_RUN_ID` when set.
- If `LLORCH_RUN_ID` is not set, the support crate SHOULD generate a run ID of the form `YYYYMMDD-HHMMSS-<git_sha8>`.
- If a short git SHA is not discoverable, the run ID MAY fall back to an epoch seconds string.
- The crate MUST NOT fail if git metadata is unavailable.

### PB-1003 Base Directory Override

- The environment variable `LLORCH_PROOF_DIR` MUST override the base directory portion of the path when set (resulting root: `$LLORCH_PROOF_DIR/<type>/<run_id>/`).

### PB-1004 File Formats & Extensions

- Streams MUST be written as NDJSON (one JSON per line) and SHOULD use the `.ndjson` or `.jsonl` extension.
- Structured configs SHOULD be JSON with pretty formatting and MUST use the `.json` extension.
- Human summaries SHOULD be Markdown and MAY use `.md` extension; raw names without extension are permitted for Markdown-only summaries.
- Timing tables MAY be CSV with `.csv` extension.

### PB-1005 Minimal API Surface

The support crate MUST provide an API surface that enables emitting the required artifacts succinctly:

- `ProofBundle::for_type(TestType)` — opens/creates the bundle root for a test type.
- `ProofBundle::root() -> &Path` — returns the resolved bundle path.
- `ProofBundle::ensure_dir(sub: &str) -> PathBuf` — ensures a subdirectory exists and returns its path.
- `ProofBundle::append_ndjson(name: &str, value: &impl Serialize)` — appends one JSON object per call to `<name>.ndjson`.
- `ProofBundle::write_json(name: &str, value: &impl Serialize)` — writes `<name>.json` with pretty formatting.
- `ProofBundle::write_markdown(name: &str, body: &str)` — writes a Markdown file verbatim (name may include `.md`).
- `ProofBundle::seeds().record(seed: impl Display)` — appends `seed=<N>` to `seeds.txt`.

### PB-1006 Safety & Idempotency

- API calls MUST create parent directories as needed.
- `append_ndjson` MUST open files in append mode and MUST append a trailing newline per record.
- `write_json` and `write_markdown` MUST overwrite existing files.

### PB-1007 Redaction & Secrets

- The crate MUST NOT perform redaction itself; it is the caller’s responsibility to redact before writing. The spec REQUIRES that bundles MUST NOT contain secrets or tokens. Callers MUST prefer `*_redacted.*` variants where raw content is sensitive.

### PB-1008 Error Handling

- All operations MUST return structured `Result` errors and MUST NOT panic on expected IO conditions (nonexistent directories, first create, etc.), except when the process is in an unrecoverable state.

### PB-1009 Concurrency

- Concurrent writes to the same file from multiple threads are NOT guaranteed to be atomic. Callers SHOULD serialize writes per file. The crate MAY add locking helpers in the future.

### PB-1010 Test Type Mapping

- The `TestType` enum in the support crate MUST map to directory names exactly as: `Unit→unit`, `Integration→integration`, `Contract→contract`, `Bdd→bdd`, `Determinism→determinism`, `Smoke→home-profile-smoke`, `E2eHaiku→e2e-haiku`.

### PB-1011 Cross-Platform Assumptions

- Paths MUST be valid on Linux filesystems. No Windows-specific paths are required for the home profile.

### PB-1012 Autogenerated Headers

- All generated proof bundle artifacts MUST indicate they were automatically generated for a proof bundle.
- For Markdown/CSV/plain-text, the FIRST line MUST be `# AUTOGENERATED: Proof Bundle`.
- For NDJSON, the FIRST record SHOULD be a metadata record (e.g., `{ "_meta": "proof_bundle", "_note": "autogenerated" }`).
- For JSON, a sibling metadata file `<name>.meta` with the header line SHOULD be written; if embedding is acceptable, a top-level field `{ "generated_by": "proof-bundle" }` MAY be included instead.

## Verification (Specs→Tests)

The following tests MUST exist in `libs/proof-bundle` and/or consuming crates to verify these requirements.

- PBV-2001: `for_type` creates `<type>/<run_id>/` with default base (PB-1001).
- PBV-2002: honors `LLORCH_PROOF_DIR` and `LLORCH_RUN_ID` (PB-1002, PB-1003).
- PBV-2003: `append_ndjson` appends one JSON object per line with newline termination (PB-1006, PB-1004).
- PBV-2004: `write_json` writes pretty JSON and overwrites existing file (PB-1006, PB-1004).
- PBV-2005: `write_markdown` writes exact body, overwriting existing file (PB-1006).
- PBV-2006: `seeds().record()` appends `seed=<N>` with newline and is idempotent for multiple calls (PB-1005, PB-1006).
- PBV-2007: `TestType` → directory mapping is exact (PB-1010).
- PBV-2008: No panics on normal flows; errors surfaced via `Result` (PB-1008).
- PBV-2009: Artifacts include the required autogenerated header or equivalent metadata per format (PB-1012).

## Cross-References

- `.docs/testing/TEST_TYPES_GUIDE.md` — Overview of test types and bundle content.
- `.proof_bundle/templates/*/README.md` — Per-type required files.
- `.docs/testing/TESTING_POLICY.md` — Policy mandating bundle emission.

## Future Work

- Add optional file locks for multi-threaded emitters.
- Add a tiny `redaction` helper module with safe patterns for common log redactions (headers/tokens), leaving actual redaction decisions to callers.
- Provide per-type convenience helpers (e.g., `determinism::write_pair`, `bdd::write_sse`).
