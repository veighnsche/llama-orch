# Proof-Bundle Crate Contracts (PB-CONTRACTS)

Status: Draft
Owner: @llama-orch-maintainers
Date: 2025-09-26

## Purpose
Define the contracts that the shared crate `libs/proof-bundle` provides to other crates, so tests across the workspace can rely on a stable API and behavior for emitting proof bundles.

## Provided Contracts

- API surface (minimal):
  - `enum TestType { Unit, Integration, Contract, Bdd, Determinism, Smoke, E2eHaiku }`
  - `ProofBundle::for_type(TestType) -> Result<ProofBundle>`
  - `ProofBundle::root() -> &Path`
  - `ProofBundle::ensure_dir(&str) -> Result<PathBuf>`
  - `ProofBundle::append_ndjson(name, &impl Serialize) -> Result<()>` (appends one JSON object per line)
  - `ProofBundle::write_json(name, &impl Serialize) -> Result<()>` (pretty JSON)
  - `ProofBundle::write_markdown(name, &str) -> Result<()>`
  - `ProofBundle::seeds().record(seed) -> Result<()>`
- Convenience helpers:
  - `ProofBundle::write_markdown_with_header(name, body)`
  - `ProofBundle::append_ndjson_autogen_meta(name)` — idempotent metadata record writer
  - `ProofBundle::write_meta_sibling(name)` — writes `<name>.meta` with header
  - `ProofBundle::write_json_with_meta(name, &value)` — calls `write_json` and writes `name.json.meta`

## Behavioral Guarantees

- Bundle location: by default under the current working directory, `.proof_bundle/<type>/<run_id>/`.
- Env overrides:
  - `LLORCH_PROOF_DIR` overrides the base directory (root becomes `$LLORCH_PROOF_DIR/<type>/<run_id>/`).
  - `LLORCH_RUN_ID` overrides the run directory name.
- Run ID generation when unset: `YYYYMMDD-HHMMSS-<git_sha8>` or epoch seconds fallback (no failure if git is unavailable).
- File formats:
  - NDJSON for streaming records; one JSON object per line; newline-terminated.
  - Pretty JSON for configs; `.json` extension enforced.
  - Markdown for human summaries.
- Autogenerated header requirement (normative):
  - Markdown/CSV/plain-text: first line MUST be `# AUTOGENERATED: Proof Bundle`.
  - NDJSON: first record SHOULD include `{ "_meta": "proof_bundle", "_note": "autogenerated" }`.
  - JSON: prefer sibling `.meta` file with the header line; embedding `{ "generated_by": "proof-bundle" }` is acceptable.
- Error handling: all operations return `anyhow::Result`; no panics for normal IO conditions.

## Non-Goals / Not Provided

- Redaction of secrets or PII. Callers must redact before writing and SHOULD emit `*_redacted.*` variants where necessary.
- Locking/atomic multi-writer guarantees. Callers should serialize writes per file.
- Network or SDK coupling. The crate does not reach network or depend on orchestrator contracts.

## Compatibility & Versioning

- Pre-1.0.0: breaking changes may occur; strive for additive evolution.
- Directory names and `TestType` mapping are normative and SHOULD NOT change without a spec revision.
- Helpers are optional; callers can use only the minimal API.

## Expectations for Consumers

- Use `LLORCH_RUN_ID` to group artifacts for a test run when invoking multiple tests in a suite.
- Use helpers to ensure the required autogenerated headers are present.
- Redact sensitive data upstream; do not write secrets.
- Prefer crate-local `.proof_bundle` for artifacts unless CI overrides `LLORCH_PROOF_DIR`.

## Dependencies

- Does not depend on other workspace crates.
- Uses `serde`, `serde_json`, and `anyhow` from the workspace.

## Verification Hooks

- The crate ships conformance tests covering the API and behavior. Run:
  - `cargo test -p proof-bundle -- --nocapture`
- CI script is available to validate headers across generated bundles:
  - `ci/scripts/check_proof_bundle_headers.sh [base_dir]`

## Examples

```rust
use proof_bundle::{ProofBundle, TestType};

let pb = ProofBundle::for_type(TestType::Integration)?;
pb.write_markdown_with_header("test_report.md", "# OK\n")?;
pb.append_ndjson_autogen_meta("streaming_transcript")?;
pb.append_ndjson("streaming_transcript", &serde_json::json!({"event":"started"}))?;
pb.write_json_with_meta("run_config", &serde_json::json!({"ok": true}))?;
pb.seeds().record(42)?;
# Ok::<(), anyhow::Error>(())
```
