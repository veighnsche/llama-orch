# Integration Test Proof Bundle Template

Required generated artifacts

- retry_timeline.jsonl — backoff events with seed and policy
- streaming_transcript.ndjson — NDJSON stream of {event:"started|token|metrics|end", ...}
- redacted_errors.* — upstream error snapshots with redaction
- seeds.txt — RNG seeds used
- test_report.md — summary and pointers

Notes

- Use local stubs only (no external network) per TESTING_POLICY.
- Avoid wall-clock sleeps; prefer mocked time.

Path layout

- <crate>/.proof_bundle/integration/<run_id>/
- run_id should be `YYYYMMDD-HHMMSS-<git_sha8>` or set `LLORCH_RUN_ID`.

Environment

- LLORCH_RUN_ID — optional, groups artifacts per run
- LLORCH_PROOF_DIR — optional, overrides base bundle dir (defaults to `<crate>/.proof_bundle`)

Formats

- Streams use NDJSON (`.ndjson`/`.jsonl`), one JSON per line
- Include per-event timing if helpful (token latency) in `timing.csv`

Autogenerated header (required)

- Markdown/plain-text: first line MUST be `# AUTOGENERATED: Proof Bundle`.
- NDJSON: first record SHOULD be `{ "_meta": "proof_bundle", "_note": "autogenerated" }`.
- JSON: prefer sibling `<name>.meta` file with the header line; embedding `{ "generated_by": "proof-bundle" }` is acceptable.

Example (Rust)

```rust
use std::fs::{create_dir_all, File};
use std::io::Write;
use std::path::PathBuf;

fn proof_root() -> PathBuf {
    let base = std::env::var("LLORCH_PROOF_DIR")
        .map(PathBuf::from)
        .unwrap_or_else(|_| PathBuf::from(env!("CARGO_MANIFEST_DIR")).join(".proof_bundle"));
    let run_id = std::env::var("LLORCH_RUN_ID").unwrap_or_else(|_| {
        let ts = std::time::SystemTime::now().duration_since(std::time::UNIX_EPOCH).unwrap().as_secs();
        format!("{}", ts)
    });
    base.join("integration").join(run_id)
}

#[test]
fn writes_stream_transcript() {
    let root = proof_root();
    create_dir_all(&root).unwrap();
    let mut f = File::create(root.join("streaming_transcript.ndjson")).unwrap();
    for e in [
        serde_json::json!({"event":"started","job_id":"J1"}),
        serde_json::json!({"event":"token","t":0,"text":"Hello"}),
        serde_json::json!({"event":"end","ok":true})
    ] { writeln!(f, "{}", e).unwrap(); }
}
```

Links

- See `.docs/testing/types/integration.md` and `.docs/testing/TEST_TYPES_GUIDE.md`.
