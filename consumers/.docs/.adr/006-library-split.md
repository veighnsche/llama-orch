# ADR-006: Split into `llama-orch-sdk`, `llama-orch-utils`, and `llama-orch-cli`

## Status

Accepted

## Context

We need a clear separation of concerns between:

* a **server-facing SDK** for llama-orch communication,
* a **Blueprint-oriented utilities library** that helps users compose applets to build Blueprints,
* and a **CLI** that generates language bindings (capability snapshots) for Blueprint projects.

**Definitions (normative):**

* **Blueprint**: an orchestration that transforms **seed files** into a **ready-for-everything software project**.
* **Software project**: the end product generated by a Blueprint.

## Decision (RFC-2119)

### 1) Crates / Binaries

* Create `llama-orch-sdk` (**SDK**): a Rust library that **MUST** provide typed, stable clients and models for llama-orch APIs (HTTP + SSE), including requests, responses, and streaming envelopes.
* Create `llama-orch-utils` (**Utils**): a Rust library that **MUST** provide Blueprint-oriented applets and helpers; it **MUST** use the SDK for all llama-orch communication and **MUST NOT** implement raw HTTP/SSE to llama-orch itself.
* Create `llama-orch-cli` (**CLI**): a Rust binary that **MUST** use the SDK to discover server capabilities and **MUST** generate language bindings (TS/JS/RS) as static files for Blueprint consumption.

### 2) Dependency Direction

* `llama-orch-utils` **MAY** depend on `llama-orch-sdk`.
* `llama-orch-sdk` **MUST NOT** depend on `llama-orch-utils`.
* `llama-orch-cli` **MUST** depend on `llama-orch-sdk` and **MUST NOT** talk to llama-orch except through the SDK.

### 3) Responsibilities & Boundaries

**SDK (llama-orch-sdk) — server-facing, agnostic**

* **MUST** expose: typed request/response models, clients, streaming handlers, error types, and minimal helpers strictly required to call llama-orch (tasks, sessions, artifacts, catalog, capabilities, etc.).
* **MUST NOT** read, require, or interpret any files generated by the CLI.
* **MUST NOT** assume Blueprint layouts, applet shapes, or project conventions.
* **SHOULD** compile for native and `wasm32-unknown-unknown` (transport abstractions for browser/Node vs native).

**Utils (llama-orch-utils) — Blueprint applets & helpers**

* **MUST** implement applets and composition utilities that make building Blueprints easy (e.g., message assembly, file IO wrappers, invocation orchestration).
* **MUST** call llama-orch **only via the SDK**.
* **MAY** ingest the CLI-generated capability files to offer compile-time checks and guardrails for Blueprints.
* **MUST NOT** expose raw llama-orch wire types beyond what the SDK already exposes.

**CLI (llama-orch-cli) — capability codegen**

* **MUST** query llama-orch **via the SDK** (e.g., `/v1/capabilities`, model catalog) and **MUST** write static bindings:

  * TypeScript: `capabilities.d.ts` + `capabilities.ts`
  * JavaScript: `capabilities.js`
  * Rust: `capabilities.rs`
* Generated files **MUST** be static snapshots (no live data such as queue depth/wait times) and **MUST** be intended for Blueprints and Utils.
* SDK **MUST** remain agnostic to the existence or contents of generated files.

### 4) Versioning & Stability

* **SDK** public API **MUST** be semver’d and stable; breaking changes require a major version bump and a migration note.
* **Utils** public API **SHOULD** be small and composable; breaking changes require a major bump and migration note.
* **CLI** outputs **MUST** include a generator version and source hashes (of server responses) to support reproducibility.

### 5) Build Targets

* **SDK** and **Utils** **SHOULD** build for native and `wasm32-unknown-unknown` (where feasible).
* **CLI** **MUST** target native only.
* Platform-specific code **MUST** be behind `cfg` gates.

### 6) Security & Side-Effects

* **SDK** **MUST NOT** shell out or perform arbitrary filesystem writes; it **MUST** be a pure client library aside from network I/O.
* **Utils** file operations **MUST** be explicit (callers provide paths); no implicit discovery.
* **CLI** **MUST** write only to user-specified output locations when generating files.

### 7) Testing

* **SDK** **MUST** include contract tests against recorded fixtures for HTTP/SSE envelopes (no live server required).
* **Utils** **MUST** include unit tests for applets and orchestration; llama-orch calls should be mocked via SDK interfaces.
* **CLI** **MUST** include golden tests for generated files (snapshot comparison).

### 8) Prohibitions

* SDK **MUST NOT** depend on Utils or read CLI outputs.
* Utils **MUST NOT** bypass the SDK to call llama-orch.
* CLI **MUST NOT** call llama-orch except through the SDK.

## Consequences

**Positive:** Clear layering, stable SDK surface, safer evolution, and straightforward Blueprint authoring aided by Utils and CLI-generated bindings.
**Negative:** Multiple packages to version and maintain.
**Trade-off:** Slight organizational overhead for long-term clarity, portability, and reproducibility.

## Notes on Terminology (for this document alone)

This ADR defines **SDK**, **Utils**, **CLI**, **Blueprint**, and **Software project** within itself so it stands alone without prior context.