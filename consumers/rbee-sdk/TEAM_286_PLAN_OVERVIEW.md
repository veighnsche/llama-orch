# TEAM-286: rbee-sdk (Rust + WASM) - Implementation Plan Overview

**Date:** Oct 24, 2025  
**Status:** 📋 **PLANNING**  
**Team:** TEAM-286  
**Approach:** Rust → WASM → JavaScript/TypeScript

---

## Mission

Build a **Rust-based SDK** that compiles to WASM for browser/Node.js usage, **reusing all existing shared crates** from the rbee monorepo.

---

## Key Insight: THIN WRAPPER, NOT REWRITE

We already have:
- ✅ `job-client` - Complete job submission + SSE streaming
- ✅ `operations-contract` - All operation types
- ✅ `rbee-config` - Configuration handling
- ✅ All error types and utilities

**We just need to:**
1. Add `wasm-bindgen` bindings to expose these to JavaScript
2. Handle JS ↔ Rust conversion
3. Compile to WASM with `wasm-pack`

---

## Plan Structure

This implementation is divided into **4 phases** (much simpler than TypeScript!):

1. **[Phase 1: WASM Setup](./TEAM_286_PHASE_1_WASM_SETUP.md)** (1 day)
   - Add wasm-bindgen dependencies
   - Configure wasm-pack
   - Basic project setup

2. **[Phase 2: Core Bindings](./TEAM_286_PHASE_2_CORE_BINDINGS.md)** (2 days)
   - Wrap job-client for WASM
   - Expose operations-contract types
   - Basic RbeeClient class

3. **[Phase 3: All Operations](./TEAM_286_PHASE_3_ALL_OPERATIONS.md)** (1-2 days)
   - Expose all operations
   - JavaScript-friendly API
   - Examples

4. **[Phase 4: Publishing](./TEAM_286_PHASE_4_PUBLISHING.md)** (1 day)
   - Build with wasm-pack
   - Publish to npm
   - Documentation

**Total Timeline: 5-6 days** (vs 10-15 for TypeScript!)

---

## Architecture

```
┌──────────────────────────────────────────────────────────┐
│  Existing Shared Crates (REUSE!)                         │
├──────────────────────────────────────────────────────────┤
│  • job-client              - HTTP + SSE streaming        │
│  • operations-contract     - All operation types         │
│  • rbee-config            - Configuration                │
│  • observability-*        - Error handling               │
└──────────────────────────────────────────────────────────┘
                           ↓
┌──────────────────────────────────────────────────────────┐
│  rbee-sdk (THIS CRATE)                                   │
│  • src/lib.rs            - wasm-bindgen wrappers         │
│  • src/client.rs         - RbeeClient wrapper            │
│  • src/types.rs          - Type conversions              │
│  • Cargo.toml            - WASM dependencies             │
└──────────────────────────────────────────────────────────┘
                           ↓ wasm-pack build
┌──────────────────────────────────────────────────────────┐
│  pkg/ (Generated by wasm-pack)                           │
│  • rbee_sdk.wasm         - Compiled WASM binary          │
│  • rbee_sdk.js           - JavaScript glue code          │
│  • rbee_sdk.d.ts         - TypeScript types (auto!)      │
│  • package.json          - Ready to publish              │
└──────────────────────────────────────────────────────────┘
                           ↓
┌──────────────────────────────────────────────────────────┐
│  JavaScript/TypeScript Usage                             │
│  import { RbeeClient } from '@rbee/sdk';                 │
│  const client = new RbeeClient('http://localhost:8500'); │
└──────────────────────────────────────────────────────────┘
```

---

## Key Benefits of Rust + WASM

### ✅ Code Reuse (CRITICAL!)
- **job-client**: Already has `submit_and_stream()` - just expose it!
- **operations-contract**: All types already defined - zero manual work!
- **No duplication**: Same code as rbee-keeper and queen-rbee
- **Shared bug fixes**: Fix in job-client, SDK gets it automatically

### ✅ Type Safety
- **Auto-generated TypeScript types** via wasm-bindgen
- **Impossible to drift**: Same Rust code as backend
- **Compile-time guarantees**: Rust compiler ensures correctness

### ✅ Performance
- **Fast**: WASM runs at near-native speed
- **Small bundle**: ~100-200KB gzipped
- **Efficient**: No JSON parsing overhead in hot paths

### ✅ Maintenance
- **Single codebase**: One implementation for all platforms
- **Fix once**: Bug fixes propagate everywhere
- **Shared tests**: Test Rust code, get JS/TS for free

---

## Comparison: TypeScript vs Rust+WASM

| Aspect | TypeScript | Rust + WASM |
|--------|-----------|-------------|
| **Development Time** | 10-15 days | 5-6 days ✅ |
| **Code Reuse** | 0% (rewrite) | 90%+ ✅ |
| **Type Sync** | Manual | Automatic ✅ |
| **Performance** | Good | Excellent ✅ |
| **Bundle Size** | ~50KB | ~150KB |
| **Maintenance** | Duplicate code | Shared code ✅ |
| **Dependencies** | 0 runtime | 0 runtime ✅ |

**Rust + WASM wins in every category that matters!**

---

## What We're Actually Building

### Thin Wrappers Around Existing Code

**NOT THIS (TypeScript approach):**
```typescript
// 500+ lines of reimplementation
async submitAndStream(operation, onLine) {
  // Reimplement HTTP logic
  // Reimplement SSE parsing
  // Reimplement error handling
  // ...
}
```

**THIS (Rust + WASM approach):**
```rust
// TEAM-286: ~20 lines - just expose existing code!
#[wasm_bindgen]
pub async fn submit_and_stream(
    &self,
    operation: JsValue,
    callback: js_sys::Function,
) -> Result<String, JsValue> {
    let op: Operation = serde_wasm_bindgen::from_value(operation)?;
    
    // REUSE job-client! Already works!
    self.client.submit_and_stream(op, |line| {
        callback.call1(&JsValue::null(), &JsValue::from_str(line))?;
        Ok(())
    }).await.map_err(|e| JsValue::from_str(&e.to_string()))
}
```

---

## Dependencies

### Existing Crates (Already Have!)
```toml
job-client = { path = "../../bin/99_shared_crates/job-client" }
operations-contract = { path = "../../bin/97_contracts/operations-contract" }
rbee-config = { path = "../../bin/99_shared_crates/rbee-config" }
```

### New WASM Dependencies (Only!)
```toml
wasm-bindgen = "0.2"
wasm-bindgen-futures = "0.4"
serde-wasm-bindgen = "0.6"
js-sys = "0.3"
web-sys = { version = "0.3", features = ["Window", "Headers", "Request", "Response"] }
```

**That's it!** No reimplementing anything.

---

## Success Criteria

### MVP (v0.1.0) - 5-6 days

- ✅ WASM compiles successfully
- ✅ job-client exposed to JavaScript
- ✅ All operations work
- ✅ TypeScript types auto-generated
- ✅ Published to npm
- ✅ Examples work in browser and Node.js

### Full (v1.0.0)

- ✅ All MVP criteria
- ✅ React hooks wrapper (pure JS, separate package)
- ✅ Comprehensive docs
- ✅ Example applications

---

## Tooling

### Build Tools
- **wasm-pack** - Build and package WASM
- **cargo** - Rust compiler
- **npm/pnpm** - Package management

### No Other Tools Needed!
- ❌ No esbuild (wasm-pack handles bundling)
- ❌ No TypeScript compiler (types auto-generated)
- ❌ No manual type generation (wasm-bindgen does it)

---

## Timeline

| Phase | Duration | What We Do |
|-------|----------|------------|
| Phase 1: WASM Setup | 1 day | Add dependencies, configure wasm-pack |
| Phase 2: Core Bindings | 2 days | Wrap job-client, expose to JS |
| Phase 3: All Operations | 1-2 days | Expose existing operations |
| Phase 4: Publishing | 1 day | Build, test, publish |
| **Total** | **5-6 days** | **vs 10-15 for TypeScript!** |

---

## Next Steps

1. **Review Phase 1** - WASM setup and dependencies
2. **Start implementation** - Add wasm-bindgen to Cargo.toml
3. **Wrap job-client** - Expose to JavaScript
4. **Compile and test** - wasm-pack build
5. **Publish** - npm publish

---

## Why This Approach Was Missed

Looking at the original handoff:
- ✅ `src/lib.rs` already exists - clearly Rust!
- ✅ `Cargo.toml` already exists - clearly Rust!
- ✅ Mission says "modernize" - not "rewrite in TypeScript"

**Lesson learned:** Always check existing project structure before planning!

---

## Engineering Rules Compliance

✅ **Consult existing code:** Use job-client, operations-contract  
✅ **No duplication:** Reuse shared crates  
✅ **Code signatures:** Add TEAM-286 to new code  
✅ **Complete handoffs:** 2 pages max with code examples  

---

**Ready to build the RIGHT way!** 🚀

---

**Created by:** TEAM-286  
**Date:** Oct 24, 2025  
**Approach:** Rust + WASM (CORRECTED)  
**Estimated Duration:** 5-6 days
