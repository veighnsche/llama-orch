<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>%%TITLE%%</title>
  <style>
    :root{--ink:#1b1f23;--muted:#586069;--ok:#106b21;--warn:#8a6d3b;--bad:#b71c1c;--bg:#fff}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;line-height:1.45;color:var(--ink);background:var(--bg);margin:0;padding:24px}
    header{margin-bottom:24px}
    h1{font-size:20px;margin:0 0 4px}
    h2{font-size:18px;margin:24px 0 8px}
    h3{font-size:16px;margin:16px 0 8px}
    p,li{font-size:14px;color:var(--ink)}
    .muted{color:var(--muted)}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin:12px 0}
    .card{border:1px solid #e1e4e8;border-radius:8px;padding:12px;background:#fff}
    .k{font-size:12px;color:var(--muted)}
    .v{font-size:18px;font-weight:600}
    table{width:100%;border-collapse:collapse;margin:8px 0 24px}
    th,td{padding:6px 8px;border:1px solid #e1e4e8;font-size:12px;text-align:right}
    th:first-child,td:first-child{text-align:left}
    .ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
    .section{page-break-inside:avoid}
    @media print{body{padding:0} .no-print{display:none}}
    .foot{margin-top:24px;font-size:12px;color:var(--muted)}
    .small{font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>%%TITLE%%</h1>
    <div class="muted small">Generated at: <span id="gen_at">%%GENERATED_AT%%</span></div>
  </header>

  <section class="section" id="exec">
    <h2>Executive Summary</h2>
    <div class="cards">
      <div class="card"><div class="k">Min DSCR</div><div class="v" id="dscr_min">–</div></div>
      <div class="card"><div class="k">Min Cash (€)</div><div class="v" id="cash_min">–</div></div>
      <div class="card"><div class="k">Runway (months to cash < 0)</div><div class="v" id="runway">–</div></div>
      <div class="card"><div class="k">Revenue (€)</div><div class="v" id="rev_total">–</div></div>
      <div class="card"><div class="k">Costs (€)</div><div class="v" id="cost_total">–</div></div>
      <div class="card"><div class="k">Margin (€)</div><div class="v" id="margin_total">–</div></div>
    </div>
    <p class="small muted" id="perc_note"></p>
  </section>

  <section class="section" id="why">
    <h2>Why this projection is realistic</h2>
    <ul id="justifications">
      <!-- populated by JS -->
    </ul>
  </section>

  <section class="section" id="pnl">
    <h2>Monthly P&L (Representative Cut)</h2>
    <table id="tbl_pnl">
      <thead>
        <tr>
          <th>Month</th>
          <th>Revenue (total)</th>
          <th>COGS (total)</th>
          <th>Opex (fixed)</th>
          <th>Depreciation</th>
          <th>EBITDA</th>
          <th>Interest</th>
          <th>EBT</th>
          <th>Tax</th>
          <th>Net Income</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section class="section" id="cashflow">
    <h2>Monthly Cashflow</h2>
    <table id="tbl_cf">
      <thead>
        <tr>
          <th>Month</th>
          <th>Starting Cash</th>
          <th>Cash from Ops</th>
          <th>Working Capital Δ</th>
          <th>VAT Cash</th>
          <th>Capex</th>
          <th>Debt Service (Interest)</th>
          <th>Debt Service (Principal)</th>
          <th>Ending Cash</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section class="section" id="loan">
    <h2>Loan Schedule</h2>
    <table id="tbl_loan">
      <thead>
        <tr>
          <th>Month</th>
          <th>Principal Opening</th>
          <th>Interest</th>
          <th>Principal Repayment</th>
          <th>Payment</th>
          <th>Principal Closing</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <div class="foot">
    Built from engine outputs; print this page to PDF for submission.
  </div>

  <script id="DATA_JSON" type="application/json">%%DATA_JSON%%</script>
  <script>
    const DATA = JSON.parse(document.getElementById('DATA_JSON').textContent);
    const fmt0 = (x) => (x === Infinity ? '∞' : (x || 0).toLocaleString(undefined,{maximumFractionDigits:0}));
    const fmt2 = (x) => (x === Infinity ? '∞' : (x || 0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}));
    const euro = (x) => '€ ' + fmt0(x);

    function setText(id, text){ const el=document.getElementById(id); if(el) el.textContent=text; }

    (function init(){
      const cons = DATA.consolidated || {};
      const total = cons.total || {};
      const k = DATA.kpis || {};
      const m = DATA.meta || {};

      // Executive cards
      setText('dscr_min', (k.dscr_min===Infinity? '∞' : (k.dscr_min||0).toFixed(2)));
      setText('cash_min', euro(k.cash_min));
      setText('runway', (k.runway_months||0).toString());
      setText('rev_total', euro(total.revenue_eur||0));
      setText('cost_total', euro(total.cost_eur||0));
      setText('margin_total', euro(total.margin_eur||0));

      if (cons.percentiles){
        const rp = cons.percentiles.report_percentiles || [];
        const sel = cons.percentiles.selected_percentile;
        const note = `Representative scenario uses the ${sel}th percentile across runs; reported percentiles: [${rp.join(', ')}].`;
        setText('perc_note', note);
      }

      // Justifications
      const J = document.getElementById('justifications');
      const autos = cons.autoscaling || DATA.autoscaling || {};
      const bullets = [
        `Representative (median-like) scenario selected: p=${(m.selected_percentile ?? cons.percentiles?.selected_percentile ?? 50)}`,
        `VAT and working capital included: VAT total € ${fmt0(DATA.monthly?.vat_cash_total || 0)}, WC Δ total € ${fmt0(DATA.monthly?.wc_delta_total || 0)}`,
        `Autoscaling sanity: avg util ${(autos.avg_util_pct ?? 0).toFixed(1)}% · p95 util ${(autos.p95_util_pct ?? 0).toFixed(1)}% · SLA violations ${(autos.sla_violations ?? 0)}`,
        `Loan schedule fully applied to cashflow (interest and principal)`
      ];
      bullets.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; J.appendChild(li); });

      // Tables
      const pnlT = document.querySelector('#tbl_pnl tbody');
      const cfT = document.querySelector('#tbl_cf tbody');
      const loanT = document.querySelector('#tbl_loan tbody');

      const pnlRows = DATA.pnl_rows || [];
      const cfRows = DATA.cf_rows || [];
      const loanRows = DATA.loan_schedule || [];

      const toNum = (v)=> Number.parseFloat(v || '0') || 0;

      // P&L
      for (let i=0;i<pnlRows.length;i++){
        const r = pnlRows[i];
        const tr = document.createElement('tr');
        const rev = toNum(r.revenue_public) + toNum(r.revenue_private);
        const cogs = toNum(r.cogs_public) + toNum(r.cogs_private);
        tr.innerHTML = `
          <td>${r.month}</td>
          <td>${euro(rev)}</td>
          <td>${euro(cogs)}</td>
          <td>${euro(toNum(r.opex_fixed))}</td>
          <td>${euro(toNum(r.depreciation))}</td>
          <td>${euro(toNum(r.EBITDA))}</td>
          <td>${euro(toNum(r.interest))}</td>
          <td>${euro(toNum(r.EBT))}</td>
          <td>${euro(toNum(r.tax))}</td>
          <td>${euro(toNum(r.NetIncome))}</td>
        `;
        pnlT.appendChild(tr);
      }

      // Cashflow
      for (let i=0;i<cfRows.length;i++){
        const r = cfRows[i];
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.month}</td>
          <td>${euro(toNum(r.starting_cash))}</td>
          <td>${euro(toNum(r.cash_from_ops))}</td>
          <td>${euro(toNum(r.working_capital_delta))}</td>
          <td>${euro(toNum(r.vat_cash))}</td>
          <td>${euro(toNum(r.capex))}</td>
          <td>${euro(toNum(r.debt_service_interest))}</td>
          <td>${euro(toNum(r.debt_service_principal))}</td>
          <td>${euro(toNum(r.ending_cash))}</td>
        `;
        cfT.appendChild(tr);
      }

      // Loan schedule
      for (let i=0;i<loanRows.length;i++){
        const r = loanRows[i];
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.month}</td>
          <td>${euro(toNum(r.principal_opening))}</td>
          <td>${euro(toNum(r.interest))}</td>
          <td>${euro(toNum(r.principal_repayment))}</td>
          <td>${euro(toNum(r.payment))}</td>
          <td>${euro(toNum(r.principal_closing))}</td>
        `;
        loanT.appendChild(tr);
      }

      // Visual indicators (optional): color DSCR card
      const dscr = Number(k.dscr_min || 0);
      const el = document.getElementById('dscr_min');
      if (dscr >= 1.2) el.classList.add('ok');
      else if (dscr >= 1.0) el.classList.add('warn');
      else el.classList.add('bad');
    })();
  </script>
</body>
</html>
