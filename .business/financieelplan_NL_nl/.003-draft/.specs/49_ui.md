# 49 — UI Testing (Vue + Vite)

Status: Draft
Version: 0.1.0

## 1. Scope

- Teststrategie voor de UI `frontend/bin/d3-sim-frontend`.
- Richt zich op component/unit tests, stores, CLI‑integratie (spawn), en basis E2E.

## 2. Principes (MUST)

- **Determinisme**: render deterministisch voor dezelfde inputs (mock JSONL progress en outputs).
- **Contracten**: CLI‑wrapper moet correcte aanroep en progress parsing garanderen.
- **Isolatie**: componenten testen geïsoleerd met mocks voor filesystem/CLI.

## 3. Testniveaus

- **Unit/Component (MUST)**
  - `InputsEditor.vue`: rendering, props, events, validatie‑meldingen (mock schema hints).
  - `RunPanel.vue`: state→args mapping (seed/pipelines/targets) en acties (Run/Stop) met mock van `runEngineCLI`.
  - `ProgressLogs.vue`: JSONL parsing en filters.
  - `OutputsViewer.vue`: laden en tonen van CSV/MD (mock fs). 
  - Charts: render smoke (data contract), geen zware visuele assertions.

- **Stores (MUST)**
  - `stores/app.ts`: default state, mutaties.
  - `stores/runs.ts`: accumuleren van progressitems (append‑only, filterbaar).

- **CLI‑contract (MUST)**
  - `lib/cli.ts` mocken: produceer synthetische JSONL regels (run_start, validated, simulated, run_done).
  - Verifieer dat UI de volgorde en velden `{ ts, level, event }` respecteert en fouten netjes toont.

- **E2E (SHOULD)**
  - Playwright of Webdriver alternatief: 
    - Start dev server (`pnpm dev`) en voer smoke flow uit: Run → logs verschijnen → outputs lijst geüpdatet.
    - Alternatief: Node‑integratietest die `lib/cli.ts` met echte `child_process.spawn` uitvoert tegen de engine scaffold.

- **Visual/Story (MAY)**
  - Gebruik `frontend/libs/storybook` (Histoire) om componentvarianten te tonen en handmatig te verifiëren.
  - Eventueel screenshot‑tests met Playwright op Histoire build.

## 4. Fixtures

- Locatie (aanbevolen): `frontend/bin/d3-sim-frontend/tests/fixtures/`
  - `jsonl/minimal.jsonl` — synthetische progressregels
  - `outputs/minimal/` — kleine CSV/MD voorbeelden voor loaders/viewers

## 5. Commando’s

- Install: `pnpm -w install`
- Dev: `pnpm -F orchyra-d3-sim-frontend dev`
- Lint/format: `pnpm -F orchyra-d3-sim-frontend lint` · `format`
- Tests (vitest) (SHOULD): `pnpm -F orchyra-d3-sim-frontend test`
- Story (Histoire): `pnpm -F orchyra-storybook story:dev`

## 6. Mocks & hulpfuncties

- JSONL generator: helper om `{ts,level,event,...}` te emitten met tijdstempels.
- CSV/MD readers: mock adapters voor `OutputsViewer` (werkt zonder echte filesystem‑rechten in browser).
- CLI spawn: mock `runEngineCLI()` met een async iterator (progress stream) en error‑pad.

## 7. Acceptance voor UI (SHOULD)

- Run‑knop disabled tijdens lopende run; Stop mogelijk (indien ondersteund).
- Logs view filtert op `level`/`event` en toont laatste 1k regels zonder UI‑hapering.
- Outputs worden na `run_done` opnieuw ingelezen en getoond.

## 8. CI (SHOULD)

- Vitest suite draaien; artifacts (screenshots, coverage) uploaden bij failures.
- Optioneel: E2E headless via Playwright tegen de dev server.

## 9. Referenties

- `32_ui.md` — UI architectuur
- `31_engine.md` — CLI contract (voor mock vorm)
- `40_testing.md` — overkoepelend regimen
