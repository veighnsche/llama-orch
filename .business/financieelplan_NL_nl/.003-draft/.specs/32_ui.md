# 32 — UI (Vue + Vite) Architectuur & Best Practices

Status: Draft
Version: 0.1.0

## 1. Doel & Scope

- Definieert de frontend‑architectuur voor D3: inputs bewerken (YAML/CSV), runs starten (CLI), voortgang/logs bekijken en artefacten (CSV/MD/PNG) presenteren.
- Richtlijnen voor componenten, state‑management, data‑ingest en visualisaties.

## 2. Principes (MUST)

- **CLI‑only integratie.** UI start de Python engine als proces (via Node backend script of spawn wrapper) — geen HTTP‑server in de engine.
- **Geen netwerk** tijdens engine‑run; alle I/O is lokaal.
- **Determinisme** zichtbaar: seed‑selectie, pipeline selectie, targets; toon `run_summary` kort.
- **Leesbaarheid** boven alles: tabellen en grafieken geven per maand de groei van klanten weer, plus prijzen, marges en capaciteit.

## 3. Projectindeling (`/.003-draft/ui/`)

```
ui/
  src/
    main.ts
    App.vue
    components/
      InputsEditor.vue        # YAML/CSV editor met schema hints (monaco of codemirror)
      RunPanel.vue            # seed, pipelines, targets, start/stop
      ProgressLogs.vue        # JSONL progress viewer + filters
      OutputsViewer.vue       # tabs: CSV-tabellen, MD‑rapport, grafieken
      Charts/
        PublicScenariosChart.vue
        PublicCapacityChart.vue
        PrivateEconomicsChart.vue
    stores/
      app.ts                  # selectie (pipelines, seeds, targets)
      runs.ts                 # huidige run status, progress items, artifacts
    lib/
      cli.ts                  # spawn wrapper voor python CLI (child_process)
      fs.ts                   # bestandshelpers (electron/node‑api)
      csv.ts                  # CSV naar arrays/series (papaparse/arquero)
      md.ts                   # Markdown renderen (markdown‑it)
  public/
  index.html
  package.json
  vite.config.ts
```

Optioneel Electron shell om filesystem API te vereenvoudigen.

## 4. Componenten

- **InputsEditor.vue**
  - Links: boomweergave van `inputs/` (operator/variables/facts)
  - Rechts: editor met schema hints en validatie (client‑side lint) — geen servercalls
  - Acties: Save, Reset (naar on‑disk), Diff vs on‑disk

- **RunPanel.vue**
  - Form controls voor: `run.random_seed`, `run.pipelines`, `targets.*`, `logging.level`
  - Knoppen: Run, Stop (proces), Clear outputs
  - Toon samenvatting van grid × replicates × MC berekend uit CSV’s en `simulation.yaml`

- **ProgressLogs.vue**
  - Stream JSONL vanuit stdout; filter op `level`, `event`, `grid_index`, `replicate_index`
  - Accumulatie in `stores/runs.ts`

- **OutputsViewer.vue**
  - Tabs:
    - Tables: lees CSV’s uit `outputs/` en toon in datagrids (paginatie, filter, export)
    - Charts: scenario stack (Public), capacity (Public), economics (Private)
    - Markdown: render `financial_plan_v3.md`

## 5. Data‑ingest & parsing (SHOULD)

- CSV parsing met `papaparse` of `arquero`; type‑guards in TypeScript.
- MD render met `markdown‑it` + anchors.
- Schaal naar grote CSV’s met lazy loading en server‑side pagination (later).

## 6. CLI integratie (MUST)

- `lib/cli.ts` spawnt: `python -m d3_engine.cli --inputs … --out … --pipelines … --seed …`
- Lees stdout line‑by‑line (JSONL) en schrijf progress naar store.
- Exit code handling: 0 (OK), 2 (VALIDATION_ERROR), 3 (RUNTIME_ERROR) → toon modals/alerts.

## 7. Visualisaties (SHOULD)

- Charts lib: `echarts` of `chart.js` (bar/line/stacked/pie).
- **Public**
  - Scenarios chart: stacked components per maand
  - Capacity chart: line/area voor `instances_needed` vs `max_instances`
- **Private**
  - Economics: margin per GPU‑klasse (bar) en tijdreeks omzet/marge

## 8. Validatie & UX safeguards

- Blok Run bij **ERROR** (client‑lint of engine‑validator).
- Toon **WARNING** banner bij renormalisatie/CSV>YAML shadowing.
- Halteer run bij saldo 0 (simulatie‑flag); toon dit expliciet in scenario’s.

## 9. State & persistentie

- Bewaar laatste runconfig (pipelines, seed, targets) in localStorage; geen secrets.
- Bewaar UI‑voorkeuren (thema, tabkeuze, kolombreedtes) persistent.

## 10. Testing (SHOULD)

- Component tests (vitest + vue‑test‑utils) voor editors/viewers.
- Integratietest: spawn dummy CLI die voorspelbare JSONL emiteert en valideer progress rendering.

## 11. Roadmap (MAY)

- Electron bundling, drag‑and‑drop CSV’s, template‑editor voor `financial_plan_v3.md`.
- Autosave en inline schema‑linting met JSON Schema.
